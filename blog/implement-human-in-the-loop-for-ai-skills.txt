1:"$Sreact.fragment"
2:I[69243,["6283","static/chunks/6283-1586b7e20e5a28d4.js","7177","static/chunks/app/layout-984d35e9d146542e.js"],""]
3:I[6476,["6283","static/chunks/6283-1586b7e20e5a28d4.js","7177","static/chunks/app/layout-984d35e9d146542e.js"],"default"]
4:I[87555,[],""]
5:I[31295,[],""]
6:I[39543,["6283","static/chunks/6283-1586b7e20e5a28d4.js","7177","static/chunks/app/layout-984d35e9d146542e.js"],"default"]
8:I[59665,[],"MetadataBoundary"]
a:I[59665,[],"OutletBoundary"]
d:I[74911,[],"AsyncMetadataOutlet"]
f:I[59665,[],"ViewportBoundary"]
11:I[26614,[],""]
:HL["https://qwer820921.github.io/_next/static/css/f71b761575b48bd6.css","style"]
:HL["https://qwer820921.github.io/_next/static/css/e57a9f01512809bb.css","style"]
:HL["https://qwer820921.github.io/_next/static/css/4bb1c53d4d41ca49.css","style"]
:HL["https://qwer820921.github.io/_next/static/css/45df6ee84bc085cd.css","style"]
0:{"P":null,"b":"EhClD8Sz3TwW-Ci0ag0BD","p":"https://qwer820921.github.io","c":["","blog","implement-human-in-the-loop-for-ai-skills"],"i":false,"f":[[["",{"children":["blog",{"children":[["slug","implement-human-in-the-loop-for-ai-skills","d"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"https://qwer820921.github.io/_next/static/css/f71b761575b48bd6.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","link","1",{"rel":"stylesheet","href":"https://qwer820921.github.io/_next/static/css/e57a9f01512809bb.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","link","2",{"rel":"stylesheet","href":"https://qwer820921.github.io/_next/static/css/4bb1c53d4d41ca49.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"zh-Hant","children":[["$","head",null,{"children":[["$","link",null,{"rel":"icon","href":"/favicon.ico"}],["$","link",null,{"rel":"apple-touch-icon","href":"/logo192.png"}],["$","link",null,{"rel":"manifest","href":"/manifest.json"}],["$","link",null,{"rel":"preload","href":"/logo192.png","as":"image"}],["$","$L2",null,{"async":true,"src":"https://www.googletagmanager.com/gtag/js?id=G-CCKVESHCQ1"}],["$","$L2",null,{"id":"google-analytics","children":"\n            window.dataLayer = window.dataLayer || [];\n            function gtag(){dataLayer.push(arguments);}\n            gtag('js', new Date());\n            gtag('config', 'G-CCKVESHCQ1');\n          "}],["$","$L2",null,{"async":true,"src":"https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2709303513603814","crossOrigin":"anonymous"}]]}],["$","body",null,{"children":[["$","$L3",null,{"children":["$","$L4",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":404}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}],["$","$L6",null,{}]]}]]}]]}],{"children":["blog",["$","$1","c",{"children":[null,["$","$L4",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["slug","implement-human-in-the-loop-for-ai-skills","d"],["$","$1","c",{"children":[null,["$","$L4",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$L7",["$","$L8",null,{"children":"$L9"}],[["$","link","0",{"rel":"stylesheet","href":"https://qwer820921.github.io/_next/static/css/45df6ee84bc085cd.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","$La",null,{"children":["$Lb","$Lc",["$","$Ld",null,{"promise":"$@e"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,["$","$1","1Z3fTNRJ6iVsOUb1CZzkd",{"children":[["$","$Lf",null,{"children":"$L10"}],null]}],null]}],false]],"m":"$undefined","G":["$11","$undefined"],"s":false,"S":true}
12:"$Sreact.suspense"
13:I[74911,[],"AsyncMetadata"]
9:["$","$12",null,{"fallback":null,"children":["$","$L13",null,{"promise":"$@14"}]}]
15:I[57113,["5953","static/chunks/app/blog/%5Bslug%5D/page-bad5b7683d758711.js"],"default"]
c:null
7:["$","article",null,{"className":"container py-5","children":[["$","div",null,{"className":"row justify-content-center","children":["$","div",null,{"className":"col-12 col-lg-8","children":["$","div",null,{"className":"card blogPost_articleCard__LIiRr","children":["$","div",null,{"className":"card-body blogPost_cardBody__5xHPD","children":[["$","header",null,{"className":"blogPost_articleHeader__dQ5vG","children":[["$","$L15",null,{"mode":"static","id":"static-back-btn"}],["$","h1",null,{"className":"blogPost_articleTitle__BCXQE","children":"【安全機制】為 AI Skill 添加「人類授權層 (Human-in-the-loop)」與權限控制"}],["$","div",null,{"className":"blogPost_articleMeta__1R_wB","children":[["$","div",null,{"className":"blogPost_metaItem__xpKuj","children":[["$","i",null,{"className":"bi bi-person-fill blogPost_metaIcon__h8wBb"}],["$","span",null,{"className":"blogPost_metaLabel__y0uVD","children":"作者:"}],"子yee"]}],["$","div",null,{"className":"blogPost_metaItem__xpKuj","children":[["$","i",null,{"className":"bi bi-calendar3 blogPost_metaIcon__h8wBb"}],["$","span",null,{"className":"blogPost_metaLabel__y0uVD","children":"日期:"}],"2026-02-11"]}]]}]]}],["$","div",null,{"className":"blogContent_blogContent__VY_R4","children":"$L16"}]]}]}]}]}],["$","$L15",null,{"mode":"floating","targetId":"static-back-btn"}]]}]
17:T172b,import uuid
import time
import json
from enum import Enum
from typing import Dict, Any, Callable, Optional

# 模擬外部通知服務 (例如 LINE Notify 或 Discord Webhook)
# 在實際應用中，這裡會發送 HTTP 請求到 LINE/Discord API
def send_approval_notification(approval_id: str, action_details: Dict[str, Any]):
    print(f"\n--- 發送審批通知 ---")
    print(f"審批 ID: {approval_id}")
    print(f"請求操作: {action_details['skill_name']}")
    print(f"參數: {json.dumps(action_details['params'], indent=2)}")
    print(f"請訪問此連結批准或拒絕: http://your-approval-service.com/approve/{approval_id}")
    print(f"---------------------")

# 模擬一個持久化層來儲存掛起的請求
# 在實際應用中，這會是 Redis 或資料庫
pending_approvals: Dict[str, Dict[str, Any]] = {}

class ApprovalStatus(Enum):
    PENDING = "PENDING"
    APPROVED = "APPROVED"
    REJECTED = "REJECTED"
    EXPIRED = "EXPIRED"

class AISkill:
    def __init__(self, name: str, func: Callable, requires_approval: bool = False):
        self.name = name
        self.func = func
        self.requires_approval = requires_approval

    def execute(self, **kwargs):
        print(f"執行 Skill: {self.name} with params: {kwargs}")
        return self.func(**kwargs)

class AIAgent:
    def __init__(self, name: str):
        self.name = name
        self.skills: Dict[str, AISkill] = {}

    def add_skill(self, skill: AISkill):
        self.skills[skill.name] = skill

    async def execute_skill(self, skill_name: str, **kwargs) -> Any:
        skill = self.skills.get(skill_name)
        if not skill:
            raise ValueError(f"Skill '{skill_name}' not found.")

        if skill.requires_approval:
            print(f"\n[Agent] Skill '{skill_name}' 需要人工審批。")
            approval_id = str(uuid.uuid4())
            action_details = {
                "skill_name": skill_name,
                "params": kwargs,
                "agent_name": self.name,
                "status": ApprovalStatus.PENDING.value,
                "timestamp": time.time()
            }
            pending_approvals[approval_id] = action_details
            send_approval_notification(approval_id, action_details)

            # 模擬等待人類審批
            print(f"[Agent] 等待人類審批 (ID: {approval_id})...")
            while pending_approvals[approval_id]["status"] == ApprovalStatus.PENDING.value:
                await asyncio.sleep(2) # 每 2 秒檢查一次

            if pending_approvals[approval_id]["status"] == ApprovalStatus.APPROVED.value:
                print(f"[Agent] Skill '{skill_name}' 已獲批准，正在執行...")
                result = skill.execute(**kwargs)
                del pending_approvals[approval_id] # 清理
                return result
            else:
                print(f"[Agent] Skill '{skill_name}' 被拒絕或過期，中止執行。")
                del pending_approvals[approval_id] # 清理
                return f"操作 '{skill_name}' 被拒絕或過期。"
        else:
            print(f"[Agent] Skill '{skill_name}' 無需審批，直接執行。")
            return skill.execute(**kwargs)

# 模擬一個後端服務來處理審批回調
# 在實際應用中，這會是一個 Flask/FastAPI/ASP.NET Core 的 endpoint
async def simulate_approval_service(approval_id: str, status: ApprovalStatus):
    if approval_id in pending_approvals:
        pending_approvals[approval_id]["status"] = status.value
        print(f"\n[Approval Service] 審批 ID {approval_id} 狀態更新為 {status.value}")
    else:
        print(f"[Approval Service] 錯誤: 審批 ID {approval_id} 不存在或已處理。")

# 實際的 Skill 函數
def sell_stock_func(symbol: str, amount: int):
    print(f"--- 執行 SellStock: 賣出 {amount} 股 {symbol} ---")
    # 這裡會是實際的交易邏輯
    return f"成功賣出 {amount} 股 {symbol}。"

def get_stock_price_func(symbol: str):
    print(f"--- 執行 GetStockPrice: 獲取 {symbol} 股價 ---")
    # 這裡會是實際的股價查詢邏輯
    return f"{symbol} 當前股價為 $175.50。"

# 主程式邏輯
import asyncio

async def main():
    my_agent = AIAgent("FinancialAgent")

    # 添加需要審批的 Skill
    my_agent.add_skill(AISkill("SellStock", sell_stock_func, requires_approval=True))
    # 添加無需審批的 Skill
    my_agent.add_skill(AISkill("GetStockPrice", get_stock_price_func, requires_approval=False))

    print("\n--- 測試無需審批的 Skill ---")
    price_result = await my_agent.execute_skill("GetStockPrice", symbol="MSFT")
    print(f"結果: {price_result}")

    print("\n--- 測試需要審批的 Skill ---")
    # 模擬 AI 嘗試賣出股票
    sell_task = asyncio.create_task(my_agent.execute_skill("SellStock", symbol="GOOG", amount=50))

    # 模擬人類在收到通知後進行批准
    await asyncio.sleep(5) # 等待通知發送
    # 假設我們知道審批 ID (從 pending_approvals 中獲取第一個)
    if pending_approvals:
        first_approval_id = list(pending_approvals.keys())[0]
        print(f"\n[Main] 模擬人類批准操作 (ID: {first_approval_id})...")
        await simulate_approval_service(first_approval_id, ApprovalStatus.APPROVED)

    sell_result = await sell_task
    print(f"結果: {sell_result}")

    print("\n--- 測試需要審批但被拒絕的 Skill ---")
    reject_task = asyncio.create_task(my_agent.execute_skill("SellStock", symbol="AMZN", amount=10))
    await asyncio.sleep(5)
    if pending_approvals:
        second_approval_id = list(pending_approvals.keys())[0]
        print(f"\n[Main] 模擬人類拒絕操作 (ID: {second_approval_id})...")
        await simulate_approval_service(second_approval_id, ApprovalStatus.REJECTED)
    reject_result = await reject_task
    print(f"結果: {reject_result}")

if __name__ == "__main__":
    asyncio.run(main())
16:[["$","h2",null,{"children":"1. Overview"}],"\n",["$","p",null,{"children":"隨著 AI Agent 的能力日益增強，它們被賦予了執行複雜任務和存取敏感系統的權限。然而，這也帶來了新的安全挑戰：如何確保 AI Agent 不會執行危險、不當或未經授權的操作？例如，一個 AI Agent 可能會錯誤地刪除資料庫、進行未經批准的金融交易，或者在遊戲中執行破壞性行為。傳統的程式安全機制不足以完全應對 LLM 可能產生的「幻覺（Hallucination）」或「提示詞注入（Prompt Injection）」攻擊 [1]。"}],"\n",["$","p",null,{"children":"為了解決這些問題，**「人類授權層（Human-in-the-loop, HITL）」**成為 Agentic AI 系統中不可或缺的安全機制。HITL 旨在將人類的判斷和監督整合到自動化流程的關鍵決策點，特別是在 AI Agent 嘗試執行高風險或敏感操作之前 [2]。它透過引入一個「確認機制」，確保所有可能產生重大影響的 AI Skill 執行都必須經過人類的明確批准。"}],"\n",["$","p",null,{"children":["本文件將深入探討如何在 AI Skill 的執行流程中實作一個強健的 HITL 機制。我們將介紹如何利用 ",["$","strong",null,{"children":["Middleware（中介層）",["$","strong",null,{"children":"模式攔截 AI 的工具呼叫（Tool Call），建立一個"}],"異步審批工作流（Asynchronous Approval Workflow）"]}],"，並整合外部通知系統（如 LINE Notify 或 Discord Webhook）來實現遠端批准。這不僅能大幅提升 AI 應用的安全性與責任歸屬，也能滿足企業在金融、醫療等受監管行業的合規性要求。"]}],"\n",["$","h2",null,{"children":"2. Architecture / Design"}],"\n",["$","p",null,{"children":"實作 Human-in-the-loop (HITL) 機制的核心在於在 AI Agent 決定執行一個 Skill 與該 Skill 實際執行之間，插入一個可控的「審批閘門」。這個閘門需要能夠攔截請求、通知人類、等待批准，並在收到批准後才放行執行。以下是其架構設計的核心模式 [3]。"}],"\n",["$","h3",null,{"children":"2.1 攔截器模式 (The Interceptor Pattern)"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"核心思想"}],"：在 AI Agent 框架（如 LangChain、Semantic Kernel）中，當 AI 決定呼叫一個外部工具或執行一個 Native Function 時，不應立即執行。而是在這個「呼叫」與「執行」之間，插入一個自定義的攔截器（Interceptor）或過濾器（Filter） [4]。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Middleware/Filters"}],"：這個攔截器作為一個中介層，負責檢查即將執行的 Skill 是否被標記為「敏感」或「需要人工審批」。如果符合條件，它將阻止 Skill 的直接執行。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"掛起狀態 (State Suspension)"}],"：當攔截器阻止執行時，AI Agent 的當前執行狀態（包括其思考過程、上下文、即將執行的 Skill 及其參數）需要被",["$","strong",null,{"children":"持久化（Check-pointing）"}],"。Agent 的執行將被暫停，進入等待（Pending）模式，直到收到人類的審批結果 [5]。"]}],"\n"]}],"\n",["$","h3",null,{"children":"2.2 異步審批工作流 (Asynchronous Approval Workflow)"}],"\n",["$","p",null,{"children":"這是 HITL 機制的關鍵部分，它定義了人類介入的流程："}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"AI 觸發敏感操作 (Trigger)"}],"：AI Agent 根據其推理結果，產生一個需要執行敏感操作的意圖，例如 ",["$","code",null,{"children":"SellStock(symbol=\"AAPL\", amount=100)"}]," 或 ",["$","code",null,{"children":"DeleteDatabase(dbName=\"Production\")"}],"。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"攔截與識別 (Intercept & Identify)"}],"：","\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":["攔截器捕獲到這個 Skill 呼叫。它會檢查該 Skill 的元數據（Metadata），例如 ",["$","code",null,{"children":"[RiskLevel(\"High\")]"}]," 或 ",["$","code",null,{"children":"[RequiresApproval(true)]"}],"，判斷其是否需要人工審批。"]}],"\n",["$","li",null,{"children":"如果需要審批，攔截器會提取 Skill 的詳細資訊（名稱、參數、AI 的推理過程等），並將其與當前 Agent 的會話 ID 一起儲存到一個**持久化層（Persistence Layer）**中。"}],"\n"]}],"\n"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"發送通知 (Notify)"}],"：","\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":["系統會透過一個通知服務，向預定義的管理者或審批人發送審批請求。通知可以透過多種管道發送，例如：","\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"LINE Notify"}],"：發送包含操作詳情和「批准/拒絕」按鈕的訊息。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Discord Webhook"}],"：發送嵌入式訊息（Embed Message），提供互動式按鈕。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Email/Slack"}],"：發送包含審批連結的通知。"]}],"\n"]}],"\n"]}],"\n",["$","li",null,{"children":["通知中應包含一個唯一的",["$","strong",null,{"children":"審批 ID (Approval ID)"}],"，用於後續的回調。"]}],"\n"]}],"\n"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"人類審批 (Human Approval)"}],"：","\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":"管理者收到通知後，審閱 AI 提出的操作請求。基於對業務影響、風險和 AI 推理的理解，管理者決定「批准」或「拒絕」該操作。"}],"\n",["$","li",null,{"children":"管理者透過點擊通知中的按鈕或訪問特定的審批介面，提交審批結果。"}],"\n"]}],"\n"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"接收回調與恢復 (Receive Callback & Resume)"}],"：","\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":"系統接收到來自通知服務的回調（Callback），其中包含審批 ID 和審批結果（批准/拒絕）。"}],"\n",["$","li",null,{"children":"系統根據審批 ID 從持久化層中檢索出之前掛起的 Agent 狀態。"}],"\n",["$","li",null,{"children":"如果審批結果是「批准」，Agent 的執行將從掛起點恢復，並執行原定的 Skill。如果審批結果是「拒絕」，則 Skill 執行被中止，Agent 可能會收到一個錯誤訊息，並根據其邏輯重新規劃或通知使用者 [6]。"}],"\n"]}],"\n"]}],"\n"]}],"\n",["$","h3",null,{"children":"2.3 權限控制與角色管理"}],"\n",["$","p",null,{"children":"除了 HITL，細粒度的權限控制也是確保 AI Agent 安全的關鍵："}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"基於角色的存取控制 (RBAC)"}],"：定義不同的使用者角色（例如：開發者、業務經理、安全審計員），並為每個角色分配不同的審批權限。例如，只有特定的安全團隊成員才能批准資料庫刪除操作。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"操作敏感度分級"}],"：為每個 Skill 定義一個敏感度級別（例如：低、中、高）。只有達到特定敏感度級別的 Skill 才需要觸發 HITL 流程。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"審批策略"}],"：可以設定多級審批（例如：需要兩人同時批准）或基於金額的審批（例如：交易金額超過 $10000 需要批准）。"]}],"\n"]}],"\n",["$","h2",null,{"children":"3. Prerequisites"}],"\n",["$","p",null,{"children":"要實作一個帶有 HITL 的 AI Skill 安全機制，您需要具備以下環境和知識："}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"AI Agent 框架"}],"：熟悉您選擇的 AI Agent 框架，例如 LangChain、LangGraph、Semantic Kernel 或自定義 Agent 框架。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"程式語言"}],"：熟悉 Python (LangChain/LangGraph) 或 C# (Semantic Kernel) 等程式語言。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"Web 服務開發"}],"：需要具備開發 Web API 的能力，用於接收通知服務的回調。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"持久化層"}],"：熟悉資料庫（如 PostgreSQL, MongoDB）或鍵值儲存（如 Redis）的使用，用於儲存 Agent 狀態和審批請求。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"通知服務 API"}],"：了解 LINE Notify、Discord Webhook 或其他通知服務的 API 整合。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"非同步程式設計"}],"：理解 ",["$","code",null,{"children":"async/await"}]," 等非同步程式設計模式，以處理異步審批工作流。"]}],"\n"]}],"\n",["$","h2",null,{"children":"4. Implementation / Code Example"}],"\n",["$","p",null,{"children":["本節將提供一個概念性的 Python 程式碼範例，展示如何在一個簡化的 AI Agent 框架中實作 HITL。我們將模擬一個 ",["$","code",null,{"children":"SellStock"}]," Skill，並在執行前觸發人工審批。"]}],"\n",["$","h3",null,{"children":"4.1 模擬 AI Agent 框架與 Skill 定義"}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"language-python","children":"$17"}]}],"\n",["$","h3",null,{"children":"4.2 程式碼說明"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":["$","code",null,{"children":"send_approval_notification"}]}],"：模擬向外部通知服務發送請求，其中包含審批 ID 和操作詳情。在實際應用中，這會是一個 HTTP POST 請求到 LINE Notify 或 Discord Webhook API。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":["$","code",null,{"children":"pending_approvals"}]}],"：一個字典，模擬持久化層，用於儲存所有待審批的請求。鍵是唯一的 ",["$","code",null,{"children":"approval_id"}],"，值是包含 Skill 名稱、參數、狀態等資訊的字典。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":[["$","code",null,{"children":"AISkill"}]," 類別"]}],"：代表一個 AI Agent 可以執行的技能。新增了 ",["$","code",null,{"children":"requires_approval"}]," 屬性來標記該 Skill 是否需要人工審批。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":[["$","code",null,{"children":"AIAgent"}]," 類別"]}],"：",["$","code",null,{"children":"execute_skill"}]," 方法是核心。當 ",["$","code",null,{"children":"skill.requires_approval"}]," 為 ",["$","code",null,{"children":"True"}]," 時，它會生成一個 ",["$","code",null,{"children":"approval_id"}],"，將請求資訊儲存到 ",["$","code",null,{"children":"pending_approvals"}],"，並呼叫 ",["$","code",null,{"children":"send_approval_notification"}],"。然後進入一個循環，等待 ",["$","code",null,{"children":"pending_approvals"}]," 中對應請求的狀態更新。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":["$","code",null,{"children":"simulate_approval_service"}]}],"：模擬一個後端 API 端點，接收來自通知服務的回調，並更新 ",["$","code",null,{"children":"pending_approvals"}]," 中請求的狀態。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":[["$","code",null,{"children":"main"}]," 函數"]}],"：展示了如何創建 Agent、添加 Skill，並測試需要審批和無需審批的 Skill。它還模擬了人類批准和拒絕的過程。"]}],"\n"]}],"\n",["$","h2",null,{"children":"5. Parameters / API Reference"}],"\n",["$","p",null,{"children":"本節將基於上述範例，抽象出實作 HITL 機制時可能涉及的關鍵參數和介面。"}],"\n",["$","h3",null,{"children":["5.1 ",["$","code",null,{"children":"AISkill"}]," 類別參數"]}],"\n",["$","table",null,{"children":[["$","thead",null,{"children":["$","tr",null,{"children":[["$","th",null,{"style":{"textAlign":"left"},"children":"參數名稱"}],["$","th",null,{"style":{"textAlign":"left"},"children":"類型"}],["$","th",null,{"style":{"textAlign":"left"},"children":"描述"}]]}]}],["$","tbody",null,{"children":[["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"name"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"str"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":"技能的唯一名稱。"}]]}],["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"func"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"Callable"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":"技能實際執行的程式碼函數。"}]]}],["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"requires_approval"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"bool"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["(可選) 指示該技能是否需要人工審批，預設為 ",["$","code",null,{"children":"False"}],"。"]}]]}]]}]]}],"\n",["$","h3",null,{"children":["5.2 ",["$","code",null,{"children":"AIAgent"}]," 類別方法"]}],"\n",["$","table",null,{"children":[["$","thead",null,{"children":["$","tr",null,{"children":[["$","th",null,{"style":{"textAlign":"left"},"children":"方法名稱"}],["$","th",null,{"style":{"textAlign":"left"},"children":"參數"}],["$","th",null,{"style":{"textAlign":"left"},"children":"描述"}]]}]}],["$","tbody",null,{"children":[["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"add_skill"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"skill: AISkill"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":"向 Agent 添加一個技能。"}]]}],["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"execute_skill"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"skill_name: str, **kwargs"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":"執行指定名稱的技能，並傳遞參數。如果需要審批，則會觸發 HITL 流程。"}]]}]]}]]}],"\n",["$","h3",null,{"children":["5.3 審批請求數據結構 (儲存在 ",["$","code",null,{"children":"pending_approvals"}]," 中)"]}],"\n",["$","table",null,{"children":[["$","thead",null,{"children":["$","tr",null,{"children":[["$","th",null,{"style":{"textAlign":"left"},"children":"欄位名稱"}],["$","th",null,{"style":{"textAlign":"left"},"children":"類型"}],["$","th",null,{"style":{"textAlign":"left"},"children":"描述"}]]}]}],["$","tbody",null,{"children":[["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"approval_id"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"str"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":"唯一的審批請求 ID。"}]]}],["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"skill_name"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"str"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":"請求執行的技能名稱。"}]]}],["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"params"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"Dict"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":"技能執行所需的參數。"}]]}],["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"agent_name"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"str"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":"發出請求的 AI Agent 名稱。"}]]}],["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"status"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"str"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["審批狀態 (",["$","code",null,{"children":"PENDING"}],", ",["$","code",null,{"children":"APPROVED"}],", ",["$","code",null,{"children":"REJECTED"}],", ",["$","code",null,{"children":"EXPIRED"}],")。"]}]]}],["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"timestamp"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"float"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":"請求發出的時間戳。"}]]}]]}]]}],"\n",["$","h3",null,{"children":"5.4 外部通知服務介面 (概念性)"}],"\n",["$","table",null,{"children":[["$","thead",null,{"children":["$","tr",null,{"children":[["$","th",null,{"style":{"textAlign":"left"},"children":"方法名稱"}],["$","th",null,{"style":{"textAlign":"left"},"children":"參數"}],["$","th",null,{"style":{"textAlign":"left"},"children":"描述"}]]}]}],["$","tbody",null,{"children":[["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"send_approval_notification"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"approval_id: str, action_details: Dict"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":"向管理者發送審批通知，包含操作詳情和審批連結。"}]]}],["$","tr",null,{"children":[["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"(Webhook Endpoint)"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":["$","code",null,{"children":"approval_id: str, status: str, approver_id: str"}]}],["$","td",null,{"style":{"textAlign":"left"},"children":"接收來自通知服務的回調，更新審批狀態。"}]]}]]}]]}],"\n",["$","h2",null,{"children":"6. Notes & Best Practices"}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"明確定義風險等級"}],"：在設計 AI Skill 時，應明確標記其潛在的風險等級和是否需要人工審批。這可以透過 Metadata 標籤（如 ",["$","code",null,{"children":"[RiskLevel(\"High\")]"}],"）或獨立的配置檔來實現 [7]。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"異步與持久化"}],"：HITL 流程本質上是異步的，AI Agent 的執行必須能夠掛起並在稍後恢復。因此，將 Agent 的狀態和待審批請求持久化到可靠的儲存（如 Redis、資料庫）至關重要，以防止系統重啟或故障導致狀態丟失 [5]。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"安全性考量"}],"：","\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"審批連結的安全性"}],"：審批連結應具有時效性、唯一性，並可能需要額外的身份驗證，以防止未經授權的批准。避免在 URL 中暴露敏感資訊。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"回調驗證"}],"：接收審批結果的回調端點必須驗證請求的來源和簽名，確保其來自合法的通知服務，防止偽造的審批請求 [8]。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"最小權限原則"}],"：通知服務和審批服務應僅擁有執行其職責所需的最小權限。"]}],"\n"]}],"\n"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"使用者體驗"}],"：","\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"清晰的通知內容"}],"：通知訊息應包含足夠的上下文資訊，讓審批人快速理解 AI 意圖和潛在影響，以便做出明智的決策。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"多管道通知"}],"：提供多種通知管道（LINE, Discord, Email, Slack），確保管理者能及時收到審批請求。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"審批介面簡潔"}],"：審批介面應簡潔明瞭，提供明確的「批准」和「拒絕」選項，並可選填理由。"]}],"\n"]}],"\n"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"錯誤處理與超時"}],"：","\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"超時機制"}],"：為審批請求設定超時時間。如果超過一定時間未收到批准，請求應自動被拒絕或標記為過期，並通知 AI Agent。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"重試機制"}],"：考慮在通知發送失敗時實作重試機制。"]}],"\n"]}],"\n"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"可觀測性"}],"：記錄所有審批請求、狀態變更和最終結果，以便進行審計、追蹤和問題排查 [9]。"]}],"\n"]}],"\n",["$","h2",null,{"children":"7. 為什麼選擇這種方式？"}],"\n",["$","p",null,{"children":"在企業級 AI 應用中引入 Human-in-the-loop (HITL) 與權限控制機制，不僅是技術上的最佳實踐，更是業務與法律合規性的必然要求。這種方式的核心價值體現在以下幾個方面："}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":[["$","strong",null,{"children":"確保關鍵操作的安全性與責任歸屬"}],"：AI Agent 雖然強大，但仍可能產生錯誤或被惡意利用。透過 HITL，所有可能導致資料損失、財務損失或違反政策的敏感操作，都必須經過人類的明確授權。這將責任歸屬從 AI 轉移到人類決策者，極大地降低了企業風險 [1]。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"防範 AI 幻覺與提示詞注入攻擊"}],"：即使是最先進的 LLM 也可能產生不準確或不恰當的內容（幻覺），或者被惡意使用者透過提示詞注入來繞過安全限制。HITL 作為最後一道防線，能夠在這些情況下阻止 AI 執行有害指令，保護系統免受潛在威脅 [10]。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"滿足合規性與審計要求"}],"：在金融、醫療、製造等高度監管的行業中，許多操作都必須有明確的審批記錄和人類決策的痕跡。HITL 機制提供了完整的審批日誌，確保了操作的可追溯性和合規性，這對於企業通過審計至關重要 [9]。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"提升 AI 系統的信任度與使用者接受度"}],"：當使用者知道 AI Agent 的關鍵決策會有人類監督時，他們對 AI 系統的信任度會顯著提高。這種透明度和控制感有助於推動 AI 技術在企業中的廣泛採用 [2]。"]}],"\n",["$","li",null,{"children":[["$","strong",null,{"children":"實現 AI 與人類的協同優化"}],"：HITL 不僅僅是安全機制，它也是一個持續改進的循環。人類的審批行為可以作為反饋數據，用於訓練和優化 AI Agent 的決策模型，使其在未來能夠更準確地判斷哪些操作需要人工介入，哪些可以自動執行，從而實現 AI 與人類的協同進化 [11]。"]}],"\n"]}],"\n",["$","hr",null,{}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"參考資料"}]}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":["[1] Orkes. (2025, August 18). ",["$","em",null,{"children":"Human-in-the-Loop in Agentic Workflows: From Definition to Implementation"}],". Retrieved from ",["$","a",null,{"href":"https://orkes.io/blog/human-in-the-loop/","children":"https://orkes.io/blog/human-in-the-loop/"}]]}],"\n",["$","li",null,{"children":["[2] Zapier. (2025, November 12). ",["$","em",null,{"children":"Human-in-the-loop in AI workflows: Meaning and patterns"}],". Retrieved from ",["$","a",null,{"href":"https://zapier.com/blog/human-in-the-loop/","children":"https://zapier.com/blog/human-in-the-loop/"}]]}],"\n",["$","li",null,{"children":["[3] Medium. (2025, September 11). ",["$","em",null,{"children":"Human-in-the-Loop Middleware: Bringing Oversight into AI Agents"}],". Retrieved from ",["$","a",null,{"href":"https://medium.com/ai-artistry/human-in-the-loop-middleware-bringing-oversight-into-ai-agents-64eb16dd999d","children":"https://medium.com/ai-artistry/human-in-the-loop-middleware-bringing-oversight-into-ai-agents-64eb16dd999d"}]]}],"\n",["$","li",null,{"children":["[4] Microsoft Learn. (2025, November 11). ",["$","em",null,{"children":"Human-in-the-Loop with AG-UI"}],". Retrieved from ",["$","a",null,{"href":"https://learn.microsoft.com/en-us/agent-framework/integrations/ag-ui/human-in-the-loop","children":"https://learn.microsoft.com/en-us/agent-framework/integrations/ag-ui/human-in-the-loop"}]]}],"\n",["$","li",null,{"children":["[5] Docs by LangChain. (n.d.). ",["$","em",null,{"children":"Interrupts"}],". Retrieved from ",["$","a",null,{"href":"https://docs.langchain.com/oss/python/langgraph/interrupts","children":"https://docs.langchain.com/oss/python/langgraph/interrupts"}]]}],"\n",["$","li",null,{"children":["[6] Flowhunt.io. (2025, November 11). ",["$","em",null,{"children":"Human in the Loop Middleware in Python: Building Safe AI Agents"}],". Retrieved from ",["$","a",null,{"href":"https://www.flowhunt.io/blog/human-in-the-loop-middleware-python-safe-ai-agents/","children":"https://www.flowhunt.io/blog/human-in-the-loop-middleware-python-safe-ai-agents/"}]]}],"\n",["$","li",null,{"children":["[7] Microsoft Learn. (2025, February 19). ",["$","em",null,{"children":"Semantic Kernel Filters"}],". Retrieved from ",["$","a",null,{"href":"https://learn.microsoft.com/en-us/semantic-kernel/concepts/enterprise-readiness/filters","children":"https://learn.microsoft.com/en-us/semantic-kernel/concepts/enterprise-readiness/filters"}]]}],"\n",["$","li",null,{"children":["[8] GitHub. (n.d.). ",["$","em",null,{"children":"Human Oversight for Autonomous AI Agents using Azure Logic Apps"}],". Retrieved from ",["$","a",null,{"href":"https://github.com/microsoft/agents-humanoversight","children":"https://github.com/microsoft/agents-humanoversight"}]]}],"\n",["$","li",null,{"children":["[9] Medium. (2025, May 7). ",["$","em",null,{"children":"Human-in-the-Loop with LangGraph: A Beginner's Guide"}],". Retrieved from ",["$","a",null,{"href":"https://sangeethasaravanan.medium.com/human-in-the-loop-with-langgraph-a-beginners-guide-8a32b7f45d6e","children":"https://sangeethasaravanan.medium.com/human-in-the-loop-with-langgraph-a-beginners-guide-8a32b7f45d6e"}]]}],"\n",["$","li",null,{"children":["[10] Reddit. (2024, August 28). ",["$","em",null,{"children":"Why does langchain use breakpoints for Human-in-the-loop actions?"}],". Retrieved from ",["$","a",null,{"href":"https://www.reddit.com/r/LangChain/comments/1f33w2y/why_does_langchain_use_breakpoints_for/","children":"https://www.reddit.com/r/LangChain/comments/1f33w2y/why_does_langchain_use_breakpoints_for/"}]]}],"\n",["$","li",null,{"children":["[11] LangChain. (n.d.). ",["$","em",null,{"children":"Human-in-the-loop using server API"}],". Retrieved from ",["$","a",null,{"href":"https://docs.langchain.com/langsmith/add-human-in-the-loop","children":"https://docs.langchain.com/langsmith/add-human-in-the-loop"}]]}],"\n"]}]]
10:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
b:null
14:{"metadata":[["$","title","0",{"children":"【安全機制】為 AI Skill 添加「人類授權層 (Human-in-the-loop)」與權限控制 | 子yee 萬事屋 | 子yee"}],["$","meta","1",{"name":"description","content":"深入探討如何在 Agentic AI 系統中實作 Human-in-the-loop (HITL) 機制，透過 Middleware 攔截、異步審批工作流與權限控制，確保 AI Skill 執行的安全性與合規性。"}],["$","meta","2",{"name":"author","content":"子yee"}],["$","meta","3",{"name":"keywords","content":"子yee 萬事屋, 台股查詢, 自選股, 技術小工具, 股票資訊平台, 技術顧問, 自動化工具"}],["$","meta","4",{"name":"google-site-verification","content":"adHIcDQiasHY4YzPlrpmSSPKl7Oj1WxrPJ_4GV4PQcM"}],["$","meta","5",{"property":"og:title","content":"【安全機制】為 AI Skill 添加「人類授權層 (Human-in-the-loop)」與權限控制"}],["$","meta","6",{"property":"og:description","content":"深入探討如何在 Agentic AI 系統中實作 Human-in-the-loop (HITL) 機制，透過 Middleware 攔截、異步審批工作流與權限控制，確保 AI Skill 執行的安全性與合規性。"}],["$","meta","7",{"property":"og:image","content":"https://qwer820921.github.io/images/img15.jpg"}],["$","meta","8",{"property":"og:image:width","content":"1200"}],["$","meta","9",{"property":"og:image:height","content":"630"}],["$","meta","10",{"property":"og:image:alt","content":"【安全機制】為 AI Skill 添加「人類授權層 (Human-in-the-loop)」與權限控制"}],["$","meta","11",{"property":"og:type","content":"article"}],["$","meta","12",{"name":"twitter:card","content":"summary_large_image"}],["$","meta","13",{"name":"twitter:title","content":"【安全機制】為 AI Skill 添加「人類授權層 (Human-in-the-loop)」與權限控制"}],["$","meta","14",{"name":"twitter:description","content":"深入探討如何在 Agentic AI 系統中實作 Human-in-the-loop (HITL) 機制，透過 Middleware 攔截、異步審批工作流與權限控制，確保 AI Skill 執行的安全性與合規性。"}],["$","meta","15",{"name":"twitter:image","content":"https://qwer820921.github.io/images/img15.jpg"}],["$","link","16",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"64x64"}]],"error":null,"digest":"$undefined"}
e:{"metadata":"$14:metadata","error":null,"digest":"$undefined"}
