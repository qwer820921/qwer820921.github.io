(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4748],{24524:(e,t,i)=>{"use strict";i.d(t,{default:()=>R});var l=i(95155),s=i(12115),a=i(65453),r=function(e){return e.IDLE="idle",e.PLAYING="playing",e.PAUSED="paused",e.WAVE_COMPLETE="wave_complete",e.WIN="win",e.LOSE="lose",e}({}),n=function(e){return e[e.NORMAL=1]="NORMAL",e[e.FAST=2]="FAST",e[e.ULTRA=4]="ULTRA",e}({}),c=function(e){return e.PATH="path",e.BUILDABLE="buildable",e.BLOCKED="blocked",e.SPAWN="spawn",e.EXIT="exit",e}({}),o=function(e){return e.SLIME="slime",e.GOBLIN="goblin",e.ORC="orc",e.DRAGON="dragon",e}({}),d=function(e){return e.BASIC="basic",e.ARCHER="archer",e.CANNON="cannon",e.MAGIC="magic",e}({}),h=function(e){return e.SINGLE="single",e.AOE="aoe",e.SLOW="slow",e}({});let x={WIDTH:1200,HEIGHT:800,BACKGROUND_COLOR:"#1a1a2e",GRID_LINE_COLOR:"rgba(255, 255, 255, 0.1)"},u={ROWS:13,COLS:20,CELL_SIZE:60},m={STARTING_GOLD:500,STARTING_LIVES:20},v={PATH:"#4a5568",BUILDABLE:"#2d3748",BLOCKED:"#1a202c",SPAWN:"#48bb78",EXIT:"#f56565",TOWER_RANGE_BORDER:"rgba(102, 126, 234, 0.5)",HOVER_VALID:"rgba(72, 187, 120, 0.3)",HOVER_INVALID:"rgba(245, 101, 101, 0.3)"},p=[{x:0,y:390},{x:270,y:390},{x:270,y:150},{x:570,y:150},{x:570,y:510},{x:870,y:510},{x:870,y:270},{x:1200,y:270}],y={1:[{x:0,y:390},{x:300,y:390},{x:600,y:390},{x:900,y:390},{x:1200,y:390}],2:[{x:0,y:210},{x:270,y:210},{x:270,y:450},{x:570,y:450},{x:570,y:210},{x:870,y:210},{x:870,y:450},{x:1200,y:450}],3:[{x:0,y:390},{x:210,y:390},{x:210,y:210},{x:510,y:210},{x:510,y:570},{x:810,y:570},{x:810,y:330},{x:1200,y:330}],4:[{x:0,y:150},{x:330,y:150},{x:330,y:450},{x:630,y:450},{x:630,y:210},{x:930,y:210},{x:930,y:510},{x:1200,y:510}],5:[{x:0,y:390},{x:150,y:390},{x:150,y:150},{x:330,y:150},{x:330,y:570},{x:510,y:570},{x:510,y:210},{x:690,y:210},{x:690,y:510},{x:870,y:510},{x:870,y:270},{x:1200,y:270}]};function g(e,t){return t&&t.length>0?t:y[e]||p}let f=[...p];function L(e){let t=e||f,i=[];for(let e=0;e<u.ROWS;e++){i[e]=[];for(let t=0;t<u.COLS;t++)i[e][t]={row:e,col:t,type:c.BUILDABLE}}(function(e){let t=new Set;for(let i=0;i<e.length-1;i++){let l=e[i],s=e[i+1];for(let e=0;e<=100;e++){let i=N({x:l.x+(s.x-l.x)*(e/100),y:l.y+(s.y-l.y)*(e/100)});i&&t.add("".concat(i.row,",").concat(i.col))}}return Array.from(t).map(e=>{let[t,i]=e.split(",").map(Number);return{row:t,col:i}})})(t).forEach(e=>{let{row:t,col:l}=e;i[t]&&i[t][l]&&(i[t][l].type=c.PATH)});let l=N(t[0]),s=N(t[t.length-1]);return l&&i[l.row]&&i[l.row][l.col]&&(i[l.row][l.col].type=c.SPAWN),s&&i[s.row]&&i[s.row][s.col]&&(i[s.row][s.col].type=c.EXIT),i}function N(e){let t=Math.floor(e.x/u.CELL_SIZE),i=Math.floor(e.y/u.CELL_SIZE);return i>=0&&i<u.ROWS&&t>=0&&t<u.COLS?{row:i,col:t}:null}function w(e,t){return{x:t*u.CELL_SIZE+u.CELL_SIZE/2,y:e*u.CELL_SIZE+u.CELL_SIZE/2}}let S=JSON.parse('{"y":[{"id":1,"name":"新手村","description":"歡迎來到塔防世界！學習基礎防禦技巧","difficulty":"easy","initialGold":500,"initialLives":20,"waves":[{"waveNumber":1,"enemies":[{"type":"slime","count":10,"interval":1000}],"delay":5000},{"waveNumber":2,"enemies":[{"type":"slime","count":15,"interval":800}],"delay":8000},{"waveNumber":3,"enemies":[{"type":"slime","count":10,"interval":1000},{"type":"goblin","count":5,"interval":1500,"delay":5000}],"delay":10000}],"rewards":{"gold":200,"stars":3}},{"id":2,"name":"森林邊境","description":"哥布林大軍來襲！加強你的防禦","difficulty":"easy","initialGold":600,"initialLives":20,"waves":[{"waveNumber":1,"enemies":[{"type":"goblin","count":12,"interval":1000}],"delay":8000},{"waveNumber":2,"enemies":[{"type":"slime","count":15,"interval":600},{"type":"goblin","count":8,"interval":1200,"delay":4000}],"delay":10000},{"waveNumber":3,"enemies":[{"type":"goblin","count":15,"interval":800},{"type":"orc","count":3,"interval":2000,"delay":6000}],"delay":12000}],"rewards":{"gold":300,"stars":3}},{"id":3,"name":"獸人高地","description":"強大的獸人戰士出現了！","difficulty":"medium","initialGold":700,"initialLives":15,"waves":[{"waveNumber":1,"enemies":[{"type":"orc","count":8,"interval":1500}],"delay":10000},{"waveNumber":2,"enemies":[{"type":"goblin","count":15,"interval":800},{"type":"orc","count":5,"interval":1800,"delay":5000}],"delay":12000},{"waveNumber":3,"enemies":[{"type":"slime","count":20,"interval":500},{"type":"goblin","count":10,"interval":1000,"delay":3000},{"type":"orc","count":6,"interval":1500,"delay":8000}],"delay":15000}],"rewards":{"gold":400,"stars":3}},{"id":4,"name":"龍之巢穴","description":"飛龍降臨！這將是一場艱難的戰鬥","difficulty":"medium","initialGold":800,"initialLives":15,"waves":[{"waveNumber":1,"enemies":[{"type":"orc","count":10,"interval":1200},{"type":"dragon","count":2,"interval":5000,"delay":8000}],"delay":15000},{"waveNumber":2,"enemies":[{"type":"goblin","count":20,"interval":700},{"type":"orc","count":8,"interval":1500,"delay":5000},{"type":"dragon","count":3,"interval":4000,"delay":12000}],"delay":18000}],"rewards":{"gold":500,"stars":3}},{"id":5,"name":"終極挑戰","description":"最終決戰！守住最後的防線！","difficulty":"hard","initialGold":1000,"initialLives":10,"waves":[{"waveNumber":1,"enemies":[{"type":"slime","count":15,"interval":600},{"type":"goblin","count":12,"interval":900,"delay":4000},{"type":"orc","count":8,"interval":1500,"delay":10000},{"type":"dragon","count":5,"interval":3000,"delay":15000}],"delay":20000}],"rewards":{"gold":1000,"stars":3}}]}');class I{getAllLevels(){return this.levels}getLevelById(e){return this.levels.find(t=>t.id===e)}getCurrentLevel(){return this.getLevelById(this.currentLevelId)}setCurrentLevel(e){return!!this.getLevelById(e)&&(this.currentLevelId=e,!0)}getNextLevel(){return this.getLevelById(this.currentLevelId+1)}goToNextLevel(){let e=this.getNextLevel();return!!e&&(this.currentLevelId=e.id,!0)}getTotalLevels(){return this.levels.length}getLevelWaves(e){let t=this.getLevelById(e);return(null==t?void 0:t.waves)||[]}getLevelInitialGold(e){let t=this.getLevelById(e);return(null==t?void 0:t.initialGold)||500}getLevelInitialLives(e){let t=this.getLevelById(e);return(null==t?void 0:t.initialLives)||20}isLastLevel(){return this.currentLevelId>=this.levels.length}reset(){this.currentLevelId=1}constructor(){this.currentLevelId=1,this.levels=S.y}}let b=new I,E={status:r.IDLE,speed:n.NORMAL,gold:m.STARTING_GOLD,lives:m.STARTING_LIVES,currentWave:0,totalWaves:10,score:0,enemies:[],towers:[],projectiles:[],selectedTowerType:null,hoveredCell:null},T=(0,a.v)((e,t)=>({...E,grid:L(),selectedTower:null,currentLevelId:1,startGame:()=>{let{currentLevelId:i}=t(),l=b.getLevelById(i);l?e({status:r.PLAYING,currentWave:1,gold:l.initialGold,lives:l.initialLives,totalWaves:l.waves.length}):e({status:r.PLAYING,currentWave:1})},pauseGame:()=>{e({status:r.PAUSED})},resumeGame:()=>{e({status:r.PLAYING})},resetGame:()=>{let{currentLevelId:i}=t(),l=b.getLevelById(i),s=g(i,null==l?void 0:l.mapPath);f=[...s];let a=L(s);e({...E,grid:a,selectedTower:null,currentLevelId:i,gold:(null==l?void 0:l.initialGold)||m.STARTING_GOLD,lives:(null==l?void 0:l.initialLives)||m.STARTING_LIVES,totalWaves:(null==l?void 0:l.waves.length)||10})},setSpeed:t=>{e({speed:t})},loadLevel:t=>{let i=b.getLevelById(t);if(i){b.setCurrentLevel(t);let l=g(t,i.mapPath);f=[...l];let s=L(l);e({...E,grid:s,selectedTower:null,currentLevelId:t,gold:i.initialGold,lives:i.initialLives,totalWaves:i.waves.length})}},nextLevel:()=>{if(b.goToNextLevel()){let t=b.getCurrentLevel();if(t){let i=g(t.id,t.mapPath);f=[...i];let l=L(i);e({...E,grid:l,selectedTower:null,currentLevelId:t.id,gold:t.initialGold,lives:t.initialLives,totalWaves:t.waves.length})}}},addEnemy:t=>{e(e=>({enemies:[...e.enemies,t]}))},removeEnemy:t=>{e(e=>({enemies:e.enemies.filter(e=>e.id!==t)}))},updateEnemy:(t,i)=>{e(e=>({enemies:e.enemies.map(e=>e.id===t?{...e,...i}:e)}))},addTower:i=>{let{grid:l}=t(),{row:s,col:a}=i.gridPosition;l[s]&&l[s][a]&&(l[s][a].towerId=i.id),e(e=>({towers:[...e.towers,i],grid:[...l]}))},removeTower:i=>{let{grid:l,towers:s}=t(),a=s.find(e=>e.id===i);if(a){let{row:e,col:t}=a.gridPosition;l[e]&&l[e][t]&&(l[e][t].towerId=void 0)}e(e=>{var t;return{towers:e.towers.filter(e=>e.id!==i),grid:[...l],selectedTower:(null==(t=e.selectedTower)?void 0:t.id)===i?null:e.selectedTower}})},selectTowerType:t=>{e({selectedTowerType:t})},selectTower:t=>{e({selectedTower:t})},setHoveredCell:t=>{e({hoveredCell:t})},addProjectile:t=>{e(e=>({projectiles:[...e.projectiles,t]}))},removeProjectile:t=>{e(e=>({projectiles:e.projectiles.filter(e=>e.id!==t)}))},addGold:t=>{e(e=>({gold:e.gold+t}))},spendGold:i=>{let{gold:l}=t();return l>=i&&(e({gold:l-i}),!0)},loseLife:t=>{e(e=>{let i=Math.max(0,e.lives-t);return{lives:i,status:i<=0?r.LOSE:e.status}})},nextWave:()=>{e(e=>{let t=e.currentWave+1;return t>e.totalWaves?{status:r.WIN}:{currentWave:t,status:r.PLAYING}})},addScore:t=>{e(e=>({score:e.score+t}))}})),j={[o.SLIME]:{type:o.SLIME,name:"史萊姆",maxHealth:100,speed:50,reward:10,damage:1,size:20,color:"#48bb78"},[o.GOBLIN]:{type:o.GOBLIN,name:"哥布林",maxHealth:200,speed:70,reward:20,damage:2,size:24,color:"#ed8936"},[o.ORC]:{type:o.ORC,name:"獸人",maxHealth:400,speed:40,reward:40,damage:3,size:28,color:"#e53e3e"},[o.DRAGON]:{type:o.DRAGON,name:"飛龍",maxHealth:1e3,speed:60,reward:100,damage:5,size:32,color:"#9f7aea"}},C={[d.BASIC]:{type:d.BASIC,name:"基礎塔",description:"基礎防禦塔，攻擊速度快",cost:100,damage:20,range:180,attackSpeed:1e3,attackType:h.SINGLE,projectileSpeed:300,color:"#667eea",icon:"\uD83D\uDDFC"},[d.ARCHER]:{type:d.ARCHER,name:"弓箭塔",description:"射程遠，傷害中等",cost:150,damage:30,range:240,attackSpeed:1500,attackType:h.SINGLE,projectileSpeed:400,color:"#48bb78",icon:"\uD83C\uDFF9"},[d.CANNON]:{type:d.CANNON,name:"火砲塔",description:"範圍攻擊，傷害高",cost:250,damage:50,range:200,attackSpeed:2500,attackType:h.AOE,projectileSpeed:200,aoeRadius:80,color:"#f56565",icon:"\uD83D\uDCA3"},[d.MAGIC]:{type:d.MAGIC,name:"魔法塔",description:"減速敵人，輔助防禦",cost:200,damage:15,range:200,attackSpeed:1200,attackType:h.SLOW,projectileSpeed:350,slowAmount:.5,color:"#9f7aea",icon:"✨"}};o.SLIME,o.SLIME,o.SLIME,o.GOBLIN,o.GOBLIN,o.SLIME,o.GOBLIN,o.ORC,o.ORC,o.GOBLIN,o.ORC,o.SLIME,o.GOBLIN,o.ORC,o.DRAGON,o.SLIME,o.GOBLIN,o.ORC,o.DRAGON;class A{clear(){this.ctx.fillStyle=x.BACKGROUND_COLOR,this.ctx.fillRect(0,0,x.WIDTH,x.HEIGHT)}renderGrid(e,t){for(let i=0;i<u.ROWS;i++)for(let l=0;l<u.COLS;l++){let s=e[i][l],a=l*u.CELL_SIZE,r=i*u.CELL_SIZE;switch(s.type){case c.PATH:this.ctx.fillStyle=v.PATH;break;case c.BUILDABLE:this.ctx.fillStyle=v.BUILDABLE;break;case c.BLOCKED:this.ctx.fillStyle=v.BLOCKED;break;case c.SPAWN:this.ctx.fillStyle=v.SPAWN;break;case c.EXIT:this.ctx.fillStyle=v.EXIT}if(this.ctx.fillRect(a,r,u.CELL_SIZE,u.CELL_SIZE),t&&t.row===i&&t.col===l){let e=s.type===c.BUILDABLE&&!s.towerId;this.ctx.fillStyle=e?v.HOVER_VALID:v.HOVER_INVALID,this.ctx.fillRect(a,r,u.CELL_SIZE,u.CELL_SIZE)}this.ctx.strokeStyle=x.GRID_LINE_COLOR,this.ctx.lineWidth=1,this.ctx.strokeRect(a,r,u.CELL_SIZE,u.CELL_SIZE)}}renderPath(){if(!(f.length<2)){this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.lineWidth=40,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath(),this.ctx.moveTo(f[0].x,f[0].y);for(let e=1;e<f.length;e++)this.ctx.lineTo(f[e].x,f[e].y);this.ctx.stroke()}}renderEnemies(e){e.forEach(e=>{if(e.isDead)return;let{x:t,y:i}=e.position;this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(t,i,e.size,0,2*Math.PI),this.ctx.fill();let l=2*e.size,s=t-l/2,a=i-e.size-10;this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(s,a,l,4);let r=e.health/e.maxHealth;this.ctx.fillStyle=r>.5?"#48bb78":r>.2?"#ed8936":"#e53e3e",this.ctx.fillRect(s,a,l*r,4)})}renderTowers(e){e.forEach(e=>{let{x:t,y:i}=e.position,l=C[e.type];this.ctx.fillStyle="rgba(0, 0, 0, 0.4)",this.ctx.beginPath(),this.ctx.ellipse(t,i+8,28,12,0,0,2*Math.PI),this.ctx.fill();let s=this.ctx.createRadialGradient(t,i,0,t,i,35);switch(s.addColorStop(0,e.color+"40"),s.addColorStop(1,"transparent"),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(t,i,35,0,2*Math.PI),this.ctx.fill(),e.type){case"basic":this.renderBasicTower(t,i,e);break;case"archer":this.renderArcherTower(t,i,e);break;case"cannon":this.renderCannonTower(t,i,e);break;case"magic":this.renderMagicTower(t,i,e);break;default:this.renderDefaultTower(t,i,e)}e.level>1&&(this.ctx.fillStyle="#fbbf24",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2,this.ctx.font="bold 14px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.strokeText("Lv".concat(e.level),t,i-30),this.ctx.fillText("Lv".concat(e.level),t,i-30)),this.ctx.font="20px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(l.icon,t,i)})}renderBasicTower(e,t,i){this.ctx.fillStyle=i.color,this.ctx.beginPath(),this.ctx.arc(e,t,24,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#4c51bf",this.ctx.beginPath(),this.ctx.arc(e,t,18,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=2,this.ctx.stroke();let l=Date.now()%2e3/2e3;this.ctx.strokeStyle="rgba(102, 126, 234, ".concat(.5-.5*l,")"),this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.arc(e,t,24+10*l,0,2*Math.PI),this.ctx.stroke()}renderArcherTower(e,t,i){this.ctx.fillStyle="#2d3748",this.ctx.beginPath(),this.ctx.arc(e,t,22,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=i.color,this.ctx.beginPath(),this.ctx.moveTo(e,t-20),this.ctx.lineTo(e-18,t+15),this.ctx.lineTo(e+18,t+15),this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.6)",this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.strokeStyle="#48bb78",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(e,t-25),this.ctx.lineTo(e,t-35),this.ctx.stroke()}renderCannonTower(e,t,i){this.ctx.fillStyle="#1a202c",this.ctx.fillRect(e-24,t-24,48,48),this.ctx.fillStyle=i.color,this.ctx.fillRect(e-20,t-20,40,40),this.ctx.fillStyle="#2d3748",this.ctx.fillRect(e-6,t-30,12,20),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=2,this.ctx.strokeRect(e-20,t-20,40,40),this.ctx.strokeStyle="#c53030",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(e-15,t),this.ctx.lineTo(e+15,t),this.ctx.stroke()}renderMagicTower(e,t,i){let l=Date.now()%3e3/3e3*Math.PI*2;this.ctx.save(),this.ctx.translate(e,t),this.ctx.rotate(l),this.ctx.strokeStyle="rgba(159, 122, 234, 0.4)",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(0,0,28,0,2*Math.PI),this.ctx.stroke();for(let e=0;e<6;e++){let t=2*Math.PI/6*e,i=25*Math.cos(t),l=25*Math.sin(t);this.ctx.fillStyle="#9f7aea",this.ctx.beginPath(),this.ctx.arc(i,l,3,0,2*Math.PI),this.ctx.fill()}this.ctx.restore(),this.ctx.fillStyle=i.color,this.ctx.beginPath();for(let i=0;i<5;i++){let l=2*Math.PI/5*i-Math.PI/2,s=i%2==0?20:10,a=e+Math.cos(l)*s,r=t+Math.sin(l)*s;0===i?this.ctx.moveTo(a,r):this.ctx.lineTo(a,r)}this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.7)",this.ctx.lineWidth=2,this.ctx.stroke();let s=this.ctx.createRadialGradient(e,t,0,e,t,8);s.addColorStop(0,"#ffffff"),s.addColorStop(1,i.color),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(e,t,8,0,2*Math.PI),this.ctx.fill()}renderDefaultTower(e,t,i){this.ctx.fillStyle=i.color,this.ctx.beginPath(),this.ctx.arc(e,t,20,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.3)",this.ctx.lineWidth=2,this.ctx.stroke()}renderTowerRange(e){let{x:t,y:i}=e.position,l=this.ctx.createRadialGradient(t,i,0,t,i,e.range);l.addColorStop(0,"rgba(102, 126, 234, 0.15)"),l.addColorStop(.7,"rgba(102, 126, 234, 0.08)"),l.addColorStop(1,"rgba(102, 126, 234, 0.02)"),this.ctx.fillStyle=l,this.ctx.beginPath(),this.ctx.arc(t,i,e.range,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle=v.TOWER_RANGE_BORDER,this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.arc(t,i,e.range,0,2*Math.PI),this.ctx.stroke(),this.ctx.setLineDash([])}renderProjectiles(e){e.forEach(e=>{if(e.hasHit)return;let{x:t,y:i}=e.position;this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(t,i,5,0,2*Math.PI),this.ctx.fill();let l=this.ctx.createRadialGradient(t,i,0,t,i,10);l.addColorStop(0,e.color),l.addColorStop(1,"transparent"),this.ctx.fillStyle=l,this.ctx.beginPath(),this.ctx.arc(t,i,10,0,2*Math.PI),this.ctx.fill()})}renderPlacementPreview(e,t){let i=C[e];if(!i)return;let{x:l,y:s}=w(t.row,t.col),a=this.ctx.createRadialGradient(l,s,0,l,s,i.range);a.addColorStop(0,"rgba(72, 187, 120, 0.2)"),a.addColorStop(.7,"rgba(72, 187, 120, 0.1)"),a.addColorStop(1,"rgba(72, 187, 120, 0.02)"),this.ctx.fillStyle=a,this.ctx.beginPath(),this.ctx.arc(l,s,i.range,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle="rgba(72, 187, 120, 0.6)",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.arc(l,s,i.range,0,2*Math.PI),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.globalAlpha=.5,this.ctx.fillStyle="rgba(0, 0, 0, 0.3)",this.ctx.beginPath(),this.ctx.ellipse(l,s+8,28,12,0,0,2*Math.PI),this.ctx.fill();let r={type:e,color:i.color,level:1,position:{x:l,y:s}};switch(e){case"basic":this.renderBasicTower(l,s,r);break;case"archer":this.renderArcherTower(l,s,r);break;case"cannon":this.renderCannonTower(l,s,r);break;case"magic":this.renderMagicTower(l,s,r);break;default:this.renderDefaultTower(l,s,r)}this.ctx.font="20px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(i.icon,l,s),this.ctx.globalAlpha=1}constructor(e){let t=e.getContext("2d");if(!t)throw Error("Failed to get canvas context");this.ctx=t}}function D(e,t){let i=t.x-e.x,l=t.y-e.y;return Math.sqrt(i*i+l*l)}function P(e){return"".concat(e,"-").concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9))}class k{start(){this.animationFrameId||(this.lastTime=performance.now(),this.loop(this.lastTime),this.startWave())}stop(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.waveSpawnTimer&&(clearTimeout(this.waveSpawnTimer),this.waveSpawnTimer=null)}update(e){this.updateEnemies(e),this.updateTowers(e),this.updateProjectiles(e),this.checkWaveComplete()}updateEnemies(e){let{enemies:t,loseLife:i,removeEnemy:l,addGold:s,addScore:a}=T.getState();t.forEach(t=>{if(t.isDead)return;let r=t.speed*(1-t.slowAmount);t.pathProgress+=r*e;let n=t.pathProgress,c=0;for(;c<f.length-1;){let e=f[c],i=f[c+1],l=D(e,i);if(n<=l){t.position=function(e,t,i){var l,s;return{x:(l=e.x,l+(t.x-l)*i),y:(s=e.y,s+(t.y-s)*i)}}(e,i,n/l),t.pathIndex=c;break}n-=l,c++}if(c>=f.length-1){i(t.damage),l(t.id);return}t.health<=0&&(t.isDead=!0,s(t.reward),a(10*t.reward),l(t.id)),t.slowAmount>0&&(t.slowAmount=Math.max(0,t.slowAmount-.5*e))})}updateTowers(e){let{towers:t,enemies:i,addProjectile:l}=T.getState(),s=performance.now();t.forEach(e=>{if(s-e.lastAttackTime<e.attackSpeed)return;let t=this.findTarget(e,i);t&&(l({id:P("projectile"),position:{...e.position},target:t,damage:e.damage,speed:e.projectileSpeed,attackType:e.attackType,aoeRadius:e.aoeRadius,slowAmount:e.slowAmount,color:e.color,hasHit:!1}),e.lastAttackTime=s)})}findTarget(e,t){let i,l=-1;return t.forEach(t=>{!t.isDead&&D(e.position,t.position)<=e.range&&t.pathProgress>l&&(i=t,l=t.pathProgress)}),i}updateProjectiles(e){let{projectiles:t,enemies:i,removeProjectile:l,updateEnemy:s}=T.getState();t.forEach(t=>{if(t.hasHit)return;let a=t.target;if(a.isDead||!i.find(e=>e.id===a.id))return void l(t.id);let r=function(e,t){let i=t.x-e.x,l=t.y-e.y,s=Math.sqrt(i*i+l*l);return 0===s?{x:0,y:0}:{x:i/s,y:l/s}}(t.position,a.position),n=t.speed*e;t.position.x+=r.x*n,t.position.y+=r.y*n,10>D(t.position,a.position)&&(t.hasHit=!0,t.attackType===h.AOE&&t.aoeRadius?i.forEach(e=>{!e.isDead&&D(a.position,e.position)<=t.aoeRadius&&s(e.id,{health:Math.max(0,e.health-t.damage)})}):t.attackType===h.SLOW&&t.slowAmount?s(a.id,{health:Math.max(0,a.health-t.damage),slowAmount:Math.max(a.slowAmount,t.slowAmount)}):s(a.id,{health:Math.max(0,a.health-t.damage)}),l(t.id))})}checkWaveComplete(){let{enemies:e,currentWave:t,totalWaves:i,nextWave:l}=T.getState();0===e.length&&0===this.enemySpawnQueue.length&&(t<i?setTimeout(()=>{l(),this.startWave()},3e3):T.setState({status:r.WIN}))}startWave(){let e=T.getState(),t=b.getLevelById(e.currentLevelId);if(!t)return;let i=t.waves[e.currentWave-1];i&&(this.enemySpawnQueue=[],i.enemies.forEach(e=>{let t=e.delay||0;for(let i=0;i<e.count;i++){let l=Date.now()+t+i*e.interval;this.enemySpawnQueue.push({type:e.type,time:l})}}),this.spawnEnemies())}spawnEnemies(){let e=()=>{let t=Date.now(),{addEnemy:i}=T.getState();for(;this.enemySpawnQueue.length>0&&this.enemySpawnQueue[0].time<=t;){let e=j[this.enemySpawnQueue.shift().type];i({id:P("enemy"),type:e.type,position:{...f[0]},health:e.maxHealth,maxHealth:e.maxHealth,speed:e.speed,pathIndex:0,pathProgress:0,reward:e.reward,damage:e.damage,size:e.size,color:e.color,isDead:!1,slowAmount:0})}this.enemySpawnQueue.length>0&&(this.waveSpawnTimer=window.setTimeout(e,100))};e()}render(){let e=T.getState();if(this.renderer.clear(),this.renderer.renderGrid(e.grid,e.hoveredCell),e.towers.forEach(e=>{this.renderer.renderTowerRange(e)}),e.selectedTowerType&&e.hoveredCell){var t;let i=null==(t=e.grid[e.hoveredCell.row])?void 0:t[e.hoveredCell.col];i&&"buildable"===i.type&&!i.towerId&&this.renderer.renderPlacementPreview(e.selectedTowerType,e.hoveredCell)}this.renderer.renderEnemies(e.enemies),this.renderer.renderTowers(e.towers),this.renderer.renderProjectiles(e.projectiles)}constructor(e){this.animationFrameId=null,this.lastTime=0,this.waveSpawnTimer=null,this.enemySpawnQueue=[],this.loop=e=>{let t=T.getState(),i=(e-this.lastTime)/1e3;if(this.lastTime=e,t.status===r.PLAYING){let e=i*t.speed;this.update(e)}this.render(),this.animationFrameId=requestAnimationFrame(this.loop)},this.renderer=new A(e)}}function R(){var e,t,i,a;let n=(0,s.useRef)(null),c=(0,s.useRef)(null),[o,d]=(0,s.useState)(!1),[h,m]=(0,s.useState)(1),{status:v,gold:p,lives:y,currentWave:g,totalWaves:f,score:L,selectedTowerType:N,selectedTower:S,hoveredCell:I,grid:E,towers:j,currentLevelId:A,startGame:D,pauseGame:R,resumeGame:O,resetGame:G,loadLevel:M,nextLevel:W,selectTowerType:B,selectTower:_,setHoveredCell:H,addTower:F,spendGold:Z}=T(),U=b.getLevelById(A),V=b.getAllLevels();(0,s.useEffect)(()=>{if(!n.current||!o)return;let e=new k(n.current);return c.current=e,()=>{e.stop()}},[o]);let z=()=>{var e;null==(e=c.current)||e.stop(),G(),d(!1)};return(0,l.jsxs)("div",{className:"tower-defense-container",children:[!o&&(0,l.jsxs)("header",{className:"tower-defense-header",children:[(0,l.jsx)("h1",{className:"game-title",children:"塔防守衛戰"}),(0,l.jsx)("p",{className:"game-subtitle",children:"TOWER DEFENSE"})]}),!o&&(0,l.jsx)("div",{className:"start-screen",children:(0,l.jsxs)("div",{className:"start-content",children:[(0,l.jsx)("div",{className:"game-logo",children:(0,l.jsx)("span",{className:"logo-icon",children:"\uD83C\uDFF0"})}),(0,l.jsx)("h2",{className:"welcome-text",children:"準備好防禦了嗎？"}),(0,l.jsxs)("p",{className:"game-description",children:["策略佈局，升級防禦塔，抵禦一波又一波的敵人進攻！",(0,l.jsx)("br",{}),"展現你的智慧，守護最後的堡壘。"]}),(0,l.jsxs)("div",{className:"level-selection",children:[(0,l.jsx)("label",{htmlFor:"level-select",className:"level-label",children:"選擇關卡："}),(0,l.jsx)("select",{id:"level-select",className:"level-select",value:h,onChange:e=>m(Number(e.target.value)),children:V.map(e=>(0,l.jsxs)("option",{value:e.id,children:["關卡 ",e.id,": ",e.name," (",e.difficulty,")"]},e.id))}),b.getLevelById(h)&&(0,l.jsxs)("div",{className:"level-info",children:[(0,l.jsx)("p",{className:"level-description",children:null==(e=b.getLevelById(h))?void 0:e.description}),(0,l.jsxs)("div",{className:"level-stats",children:[(0,l.jsxs)("span",{children:["\uD83D\uDCB0 初始金幣:"," ",null==(t=b.getLevelById(h))?void 0:t.initialGold]}),(0,l.jsxs)("span",{children:["❤️ 初始生命:"," ",null==(i=b.getLevelById(h))?void 0:i.initialLives]}),(0,l.jsxs)("span",{children:["\uD83C\uDF0A 波數:"," ",null==(a=b.getLevelById(h))?void 0:a.waves.length]})]})]})]}),(0,l.jsxs)("div",{className:"features",children:[(0,l.jsxs)("div",{className:"feature-item",children:[(0,l.jsx)("span",{className:"feature-icon",children:"\uD83C\uDFF9"}),(0,l.jsx)("span",{className:"feature-text",children:"多種防禦塔"})]}),(0,l.jsxs)("div",{className:"feature-item",children:[(0,l.jsx)("span",{className:"feature-icon",children:"\uD83D\uDC7E"}),(0,l.jsx)("span",{className:"feature-text",children:"多樣化敵人"})]}),(0,l.jsxs)("div",{className:"feature-item",children:[(0,l.jsx)("span",{className:"feature-icon",children:"⚡"}),(0,l.jsx)("span",{className:"feature-text",children:"酷炫技能"})]})]}),(0,l.jsxs)("button",{className:"start-button",onClick:()=>{M(h),d(!0),D(),setTimeout(()=>{var e;null==(e=c.current)||e.start()},100)},children:[(0,l.jsx)("span",{className:"button-icon",children:"\uD83C\uDFAE"}),(0,l.jsx)("span",{className:"button-text",children:"開始遊戲"})]})]})}),(0,l.jsxs)("div",{className:"game-screen",style:{opacity:+!!o,pointerEvents:o?"all":"none",transition:"opacity 0.5s ease",position:o?"relative":"absolute",visibility:o?"visible":"hidden"},children:[(0,l.jsxs)("div",{className:"hud-panel hud-top",children:[(0,l.jsxs)("div",{className:"hud-stats-group",children:[(0,l.jsxs)("div",{className:"hud-stat-item level-name-item",title:"當前關卡",children:[(0,l.jsx)("span",{className:"hud-stat-icon",children:"\uD83C\uDFAF"}),(0,l.jsx)("span",{className:"hud-stat-value",children:(null==U?void 0:U.name)||"未知關卡"})]}),(0,l.jsxs)("div",{className:"hud-stat-item",title:"金幣",children:[(0,l.jsx)("span",{className:"hud-stat-icon",children:"\uD83D\uDCB0"}),(0,l.jsx)("span",{className:"hud-stat-value",children:Math.floor(p)})]}),(0,l.jsxs)("div",{className:"hud-stat-item",title:"生命值",children:[(0,l.jsx)("span",{className:"hud-stat-icon",children:"❤️"}),(0,l.jsx)("span",{className:"hud-stat-value",children:y})]}),(0,l.jsxs)("div",{className:"hud-stat-item",title:"波次",children:[(0,l.jsx)("span",{className:"hud-stat-icon",children:"\uD83C\uDF0A"}),(0,l.jsxs)("span",{className:"hud-stat-value",children:[g,"/",f]})]}),(0,l.jsxs)("div",{className:"hud-stat-item",title:"分數",children:[(0,l.jsx)("span",{className:"hud-stat-icon",children:"\uD83C\uDFC6"}),(0,l.jsx)("span",{className:"hud-stat-value",children:L})]})]}),(0,l.jsxs)("div",{className:"hud-controls-group",children:[v===r.PLAYING&&(0,l.jsx)("button",{className:"hud-icon-btn pause",onClick:R,title:"暫停",children:"⏸️"}),v===r.PAUSED&&(0,l.jsx)("button",{className:"hud-icon-btn resume",onClick:O,title:"繼續",children:"▶️"}),(0,l.jsx)("button",{className:"hud-icon-btn restart",onClick:z,title:"重新開始",children:"\uD83D\uDD04"})]})]}),(0,l.jsx)("div",{className:"game-canvas-wrapper",children:(0,l.jsx)("canvas",{ref:n,id:"game-canvas",width:x.WIDTH,height:x.HEIGHT,onClick:()=>{if(!I)return;let e=E[I.row][I.col];if(e.towerId){let t=j.find(t=>t.id===e.towerId);if(t){_(t),B(null);return}}if(!N||"buildable"!==e.type||e.towerId)return;let t=C[N];if(!Z(t.cost))return;let i=w(I.row,I.col);F({id:P("tower"),type:N,position:i,gridPosition:{row:I.row,col:I.col},damage:t.damage,range:t.range,attackSpeed:t.attackSpeed,attackType:t.attackType,projectileSpeed:t.projectileSpeed,aoeRadius:t.aoeRadius,slowAmount:t.slowAmount,color:t.color,lastAttackTime:performance.now()-t.attackSpeed,level:1}),B(null)},onMouseMove:e=>{let t=n.current;if(!t)return;let i=t.getBoundingClientRect(),l=t.width/i.width,s=t.height/i.height,a=(e.clientX-i.left)*l,r=(e.clientY-i.top)*s,c=Math.floor(a/u.CELL_SIZE),o=Math.floor(r/u.CELL_SIZE);o>=0&&o<u.ROWS&&c>=0&&c<u.COLS?H({row:o,col:c}):H(null)},onMouseLeave:()=>{H(null)}})}),(0,l.jsx)("div",{className:"hud-panel hud-bottom",children:(0,l.jsx)("div",{className:"tower-dock",children:Object.values(C).map(e=>(0,l.jsxs)("button",{className:"tower-dock-btn ".concat(N===e.type?"selected":""),onClick:()=>B(e.type),disabled:p<e.cost,title:"".concat(e.name," (傷害: ").concat(e.damage,", 射程: ").concat(e.range,")"),children:[(0,l.jsx)("span",{className:"dock-icon",children:e.icon}),(0,l.jsx)("span",{className:"dock-cost",children:e.cost})]},e.type))})}),(v===r.WIN||v===r.LOSE)&&(0,l.jsx)("div",{className:"game-over-overlay",children:(0,l.jsxs)("div",{className:"game-over-content",children:[(0,l.jsx)("h2",{className:"game-over-title",children:v===r.WIN?"\uD83C\uDF89 勝利!":"\uD83D\uDC80 失敗"}),(0,l.jsxs)("p",{className:"game-over-level",children:["關卡: ",null==U?void 0:U.name]}),(0,l.jsxs)("p",{className:"game-over-score",children:["最終分數: ",L]}),(0,l.jsxs)("div",{className:"game-over-actions",children:[(0,l.jsx)("button",{className:"restart-button",onClick:z,children:"再玩一次"}),v===r.WIN&&b.getNextLevel()&&(0,l.jsx)("button",{className:"next-level-button",onClick:()=>{var e;null==(e=c.current)||e.stop(),W(),d(!0),D(),setTimeout(()=>{var e;null==(e=c.current)||e.start()},100)},children:"下一關 →"}),v===r.WIN&&!b.getNextLevel()&&(0,l.jsx)("p",{className:"congratulations",children:"\uD83C\uDF8A 恭喜通關所有關卡！"})]})]})}),S&&(0,l.jsx)("div",{className:"tower-info-overlay",onClick:()=>_(null),children:(0,l.jsxs)("div",{className:"tower-info-modal",onClick:e=>e.stopPropagation(),children:[(0,l.jsxs)("div",{className:"modal-header",children:[(0,l.jsxs)("h3",{className:"modal-title",children:[(0,l.jsx)("span",{className:"modal-icon",children:C[S.type].icon}),C[S.type].name]}),(0,l.jsx)("button",{className:"close-button",onClick:()=>_(null),children:"✕"})]}),(0,l.jsxs)("div",{className:"modal-body",children:[(0,l.jsxs)("div",{className:"info-grid",children:[(0,l.jsxs)("div",{className:"info-card",children:[(0,l.jsx)("div",{className:"info-icon",children:"\uD83D\uDCCA"}),(0,l.jsx)("div",{className:"info-label",children:"等級"}),(0,l.jsxs)("div",{className:"info-value",children:["Lv.",S.level]})]}),(0,l.jsxs)("div",{className:"info-card",children:[(0,l.jsx)("div",{className:"info-icon",children:"⚔️"}),(0,l.jsx)("div",{className:"info-label",children:"傷害"}),(0,l.jsx)("div",{className:"info-value",children:S.damage})]}),(0,l.jsxs)("div",{className:"info-card",children:[(0,l.jsx)("div",{className:"info-icon",children:"\uD83D\uDCCF"}),(0,l.jsx)("div",{className:"info-label",children:"射程"}),(0,l.jsx)("div",{className:"info-value",children:S.range})]}),(0,l.jsxs)("div",{className:"info-card",children:[(0,l.jsx)("div",{className:"info-icon",children:"⚡"}),(0,l.jsx)("div",{className:"info-label",children:"攻速"}),(0,l.jsxs)("div",{className:"info-value",children:[(1e3/S.attackSpeed).toFixed(1),"/s"]})]})]}),(0,l.jsx)("div",{className:"modal-actions",children:(0,l.jsxs)("button",{className:"sell-button",onClick:()=>{let e=Math.floor(.5*C[S.type].cost);T.getState().addGold(e),T.getState().removeTower(S.id),_(null)},children:["\uD83D\uDCB0 拆除塔 (+",Math.floor(.5*C[S.type].cost)," ","金幣)"]})})]})]})})]})]})}i(86941)},65453:(e,t,i)=>{"use strict";i.d(t,{v:()=>c});var l=i(12115);let s=e=>{let t,i=new Set,l=(e,l)=>{let s="function"==typeof e?e(t):e;if(!Object.is(s,t)){let e=t;t=(null!=l?l:"object"!=typeof s||null===s)?s:Object.assign({},t,s),i.forEach(i=>i(t,e))}},s=()=>t,a={setState:l,getState:s,getInitialState:()=>r,subscribe:e=>(i.add(e),()=>i.delete(e))},r=t=e(l,s,a);return a},a=e=>e?s(e):s,r=e=>e,n=e=>{let t=a(e),i=e=>(function(e,t=r){let i=l.useSyncExternalStore(e.subscribe,l.useCallback(()=>t(e.getState()),[e,t]),l.useCallback(()=>t(e.getInitialState()),[e,t]));return l.useDebugValue(i),i})(t,e);return Object.assign(i,t),i},c=e=>e?n(e):n},86941:()=>{},91601:(e,t,i)=>{Promise.resolve().then(i.bind(i,24524))}},e=>{var t=t=>e(e.s=t);e.O(0,[5996,8441,1684,7358],()=>t(91601)),_N_E=e.O()}]);