(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[694],{9134:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});var n=r(95155);r(12115);var l=r(70808);let a=e=>{let{value:t,onChange:r}=e;return(0,n.jsxs)("div",{className:"d-flex flex-column align-items-center",children:[(0,n.jsx)("h5",{children:"顏色選擇"}),(0,n.jsx)(l.xk,{color:t,onChange:e=>{r(e.hex)}})]})}},27152:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>w});var n=r(95155),l=r(12115),a=r(43745),s=r(5790),i=r(30967),c=r(16850),o=r(94139),d=r(31523),u=r(81796),h=r(95789),m=r(77126),x=r(66449),v=r(60902),j=r(8827),p=r(89139);let b=e=>{};var f=r(13568),g=r(9134);let A=()=>{let e=window.innerWidth>=1080;if(console.log(window.innerWidth),e)return{width:.8*window.innerWidth,height:.8*window.innerHeight};let t=Math.min(.9*window.innerWidth,1080)/1080;return{width:Math.floor(1080*t),height:Math.floor(1920*t)}};function w(){let e=(0,l.useRef)(null),t=(0,l.useRef)(null),r=(0,l.useRef)(null),w=(0,l.useRef)(new Map),y=(0,l.useRef)(null),[C,N]=(0,l.useState)([]),[E,k]=(0,l.useState)(null),[S,z]=(0,l.useState)(!1),[L,R]=(0,l.useState)(!1),[I,W]=(0,l.useState)("10"),[F,O]=(0,l.useState)("webm"),[U,H]=(0,l.useState)("30"),[G,P]=(0,l.useState)("canvas-video"),[_,D]=(0,l.useState)("png"),[M,T]=(0,l.useState)("canvas-image"),[B,V]=(0,l.useState)(A()),[q,X]=(0,l.useState)(""),[Y,J]=(0,l.useState)(null),[K,Q]=(0,l.useState)(!1),[Z,$]=(0,l.useState)(!1),ee=(0,l.useRef)(void 0);(0,l.useEffect)(()=>{if(!t.current)return;let r=new a.Hl("video-canvas",{width:B.width,height:B.height,backgroundColor:"#f0f0f0",preserveObjectStacking:!0});return e.current=r,()=>{w.current.forEach(e=>{cancelAnimationFrame(e)}),w.current.clear(),r.dispose()}},[B]),(0,l.useEffect)(()=>{let r=()=>{t.current&&e.current&&(e.current.setWidth(t.current.clientWidth),e.current.renderAll())};return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[]);let et=e=>new Promise((t,r)=>{let n=new Image;n.crossOrigin="anonymous",n.onload=()=>{try{let e=new a._V(n,{left:100,top:100,scaleX:.5,scaleY:.5,selectable:!0,hasControls:!0,lockUniScaling:!1,lockRotation:!1,borderColor:"#3f51b5",cornerColor:"#3f51b5",cornerSize:12,transparentCorners:!1}),r="obj-".concat(Date.now());e.set("data",{id:r}),t(e)}catch(e){r(e)}},n.onerror=()=>r(Error("圖片加載失敗")),n.src=e}),er=e=>new Promise((t,r)=>{let n=document.createElement("canvas"),l=n.getContext("2d");if(!l)return void r(Error("無法獲取臨時畫布上下文"));n.width=e.videoWidth,n.height=e.videoHeight,l.drawImage(e,0,0,n.width,n.height);let s=new Image;s.crossOrigin="anonymous",s.onload=()=>{try{let e=new a._V(s,{left:100,top:100,scaleX:.5,scaleY:.5,selectable:!0,hasControls:!0,lockUniScaling:!1,lockRotation:!1,borderColor:"#3f51b5",cornerColor:"#3f51b5",cornerSize:12,transparentCorners:!1}),r="vid-".concat(Date.now());e.set("data",{id:r}),t(e)}catch(e){r(e)}},s.onerror=()=>r(Error("影片幀圖片加載失敗")),s.src=n.toDataURL("image/png")}),en=async e=>{var t;let r=null==(t=e.target.files)?void 0:t[0];if(!r)return;let n=URL.createObjectURL(r);k(n);try{if(r.type.startsWith("image/")){let e=await et(n);N(t=>[...t,{id:e.get("data").id,type:"image",object:e,canChangeColor:!1}])}else if(r.type.startsWith("video/")){let e=document.createElement("video");e.style.display="none",e.src=n,e.muted=!0,e.loop=!0,e.crossOrigin="anonymous",e.playsInline=!0,document.body.appendChild(e),e.addEventListener("error",e=>{console.error("影片加載錯誤:",e)}),await new Promise(t=>{e.addEventListener("canplay",()=>{t()}),e.load()});let t=await er(e);N(r=>[...r,{id:t.get("data").id,type:"video",object:t,videoElement:e,canChangeColor:!1}]),e.play().catch(e=>{console.error("自動播放失敗:",e)})}}catch(e){console.error("處理檔案時發生錯誤:",e)}};(0,l.useEffect)(()=>{if(e.current)return e.current.clear(),e.current.backgroundColor="#f0f0f0",e.current.renderAll(),w.current.forEach(e=>{cancelAnimationFrame(e)}),w.current.clear(),C.forEach(t=>{var r;if(null==(r=e.current)||r.add(t.object),"video"===t.type&&t.videoElement){let r=()=>{if(!e.current||!t.videoElement||!t.object)return;let n=document.createElement("canvas"),l=n.getContext("2d");if(!l)return;n.width=t.videoElement.videoWidth,n.height=t.videoElement.videoHeight,l.drawImage(t.videoElement,0,0,n.width,n.height);let s=new Image;s.onload=()=>{var n,l;if(t.object&&t.object instanceof a._V&&(t.object.setElement(s),null==(n=e.current)||n.renderAll(),!(null==(l=t.videoElement)?void 0:l.paused))){let e=requestAnimationFrame(r);w.current.set(t.id,e)}},s.src=n.toDataURL("image/png")};r()}}),C.length>0&&e.current.setActiveObject(C[C.length-1].object),e.current.renderAll(),()=>{w.current.forEach(e=>{cancelAnimationFrame(e)}),w.current.clear()}},[C]);let el=(0,l.useCallback)(()=>{e.current&&(w.current.forEach(e=>{cancelAnimationFrame(e)}),w.current.clear(),e.current.clear(),e.current.backgroundColor="#f0f0f0",e.current.renderAll(),C.forEach(e=>{if(e.videoElement){var t;e.videoElement.pause();let r=e.videoElement.cloneNode(!1);null==(t=e.videoElement.parentNode)||t.replaceChild(r,e.videoElement),r.src="",r.remove()}e.object instanceof a._V&&e.object.dispose()}),k(null),N([]))},[C]),ea=t=>{if(!e.current)return;let r=C.find(e=>e.id===t);if(r){let l=w.current.get(r.id);if(l&&(cancelAnimationFrame(l),w.current.delete(r.id)),e.current.remove(r.object),r.videoElement){var n;r.videoElement.pause();let e=r.videoElement.cloneNode(!1);null==(n=r.videoElement.parentNode)||n.replaceChild(e,r.videoElement),e.src="",e.remove()}r.object instanceof a._V&&r.object.dispose(),N(e=>e.filter(e=>e.id!==t)),e.current.renderAll()}},es=t=>{if(!e.current)return;let r=C.find(e=>e.id===t);r&&(e.current.setActiveObject(r.object),e.current.renderAll())},ei=()=>{if(!e.current||0===C.length){f.Ay.error("畫布為空，無法下載！"),R(!1),ee.current=void 0;return}if(C.some(e=>"video"===e.type)){let t=parseFloat(I);if(isNaN(t)||t<1||t>30){f.Ay.error("請輸入 1-30 秒的有效時長"),f.Ay.dismiss(ee.current),ee.current=void 0,R(!1);return}if(!G||/[\\/:*?"<>|]/.test(G)){f.Ay.error("檔案名稱無效，請避免特殊字元"),f.Ay.dismiss(ee.current),R(!1),ee.current=void 0;return}C.forEach(e=>{e.videoElement&&(e.videoElement.currentTime=0,e.videoElement.play().catch(e=>{console.error("重新播放失敗:",e)}))});let r=e.current.getElement().captureStream(parseInt(U)),n=[];y.current=new MediaRecorder(r,{mimeType:"video/webm"}),y.current.ondataavailable=e=>{e.data.size>0&&n.push(e.data)},y.current.onstop=()=>{let e=new Blob(n,{type:"video/webm"}),t=URL.createObjectURL(e),r=document.createElement("a");r.href=t,r.download="".concat(G,".webm"),r.click(),URL.revokeObjectURL(t),C.forEach(e=>{e.videoElement&&e.videoElement.paused&&e.videoElement.play().catch(e=>{console.error("恢復播放失敗:",e)})}),f.Ay.dismiss(ee.current),f.Ay.success("下載成功！"),ee.current=void 0,R(!1)},y.current.start(),setTimeout(()=>{y.current&&"inactive"!==y.current.state&&y.current.stop()},1e3*t)}else{let t;if(!M||/[\\/:*?"<>|]/.test(M)){f.Ay.error("檔案名稱無效，請避免特殊字元"),f.Ay.dismiss(ee.current),ee.current=void 0,R(!1);return}if(t="jpeg"===_?e.current.toDataURL({format:"jpeg",quality:.8,multiplier:1}):e.current.toDataURL({format:"png",multiplier:1})){let e=document.createElement("a");e.href=t,e.download="".concat(M,".").concat(_),e.click(),f.Ay.dismiss(ee.current),f.Ay.success("下載成功！"),ee.current=void 0,R(!1)}R(!1)}},ec=(r,n)=>{if(e.current&&t.current){let l=r||t.current.clientWidth;e.current.setDimensions({width:l,height:n}),V({width:l,height:n}),e.current.renderAll()}},eo=t=>{e.current&&(e.current.setActiveObject(t.object),e.current.renderAll(),t.canChangeColor&&(J(t),es(t.id),Q(!0)))};return(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"row justify-content-center",children:[(0,n.jsx)("div",{className:"col-12 col-lg-10",children:(0,n.jsx)("div",{className:"card mb-4",children:(0,n.jsxs)("div",{className:"card-body",children:[(0,n.jsxs)("div",{className:"d-flex justify-content-between align-items-start mb-3 w-100",children:[(0,n.jsxs)("div",{className:"d-flex flex-wrap gap-2 me-2",style:{maxWidth:"calc(100% - 100px)"},children:[(0,n.jsxs)("button",{onClick:()=>{var e;return null==(e=r.current)?void 0:e.click()},className:"btn btn-outline-primary text-nowrap",children:[(0,n.jsx)(s.A,{size:16,className:"me-1"}),"上傳"]}),(0,n.jsxs)("button",{className:"btn btn-outline-success text-nowrap",disabled:0===C.length||L,onClick:()=>{e.current&&(e.current.discardActiveObject(),e.current.renderAll()),z(!0)},children:[(0,n.jsx)(i.A,{size:16,className:"me-1"}),"下載"]}),(0,n.jsxs)(m.A,{as:x.A,className:"text-nowrap",children:[(0,n.jsxs)(v.A,{variant:"outline-secondary",className:"text-nowrap",children:[(0,n.jsx)(c.A,{size:16,className:"me-1"}),"尺寸"]}),(0,n.jsx)(m.A.Toggle,{split:!0,variant:"outline-secondary",id:"canvas-size-dropdown"}),(0,n.jsxs)(m.A.Menu,{children:[(0,n.jsx)(m.A.Header,{children:"常用尺寸"}),(0,n.jsx)(m.A.Item,{onClick:()=>ec(1080,1920),children:"Instagram 動態 (1080x1920)"}),(0,n.jsx)(m.A.Item,{onClick:()=>ec(1080,1350),children:"Instagram 貼文 (1080x1350)"}),(0,n.jsx)(m.A.Item,{onClick:()=>ec(1080,1080),children:"Instagram 方形 (1080x1080)"}),(0,n.jsx)(m.A.Item,{onClick:()=>ec(A().width,A().height),children:"初始化尺寸"}),(0,n.jsx)(m.A.Divider,{}),(0,n.jsx)(m.A.Header,{children:"自訂"}),(0,n.jsxs)("div",{className:"px-3 py-2",children:[(0,n.jsxs)(j.A.Group,{className:"mb-2",children:[(0,n.jsx)(j.A.Label,{className:"small mb-1",children:"寬度 (px)"}),(0,n.jsx)(j.A.Control,{type:"number",size:"sm",value:B.width,onChange:e=>ec(Number(e.target.value),B.height)})]}),(0,n.jsxs)(j.A.Group,{children:[(0,n.jsx)(j.A.Label,{className:"small mb-1",children:"高度 (px)"}),(0,n.jsx)(j.A.Control,{type:"number",size:"sm",value:B.height,onChange:e=>ec(B.width,Number(e.target.value))})]})]})]})]}),(0,n.jsxs)(m.A,{as:x.A,className:"text-nowrap",children:[(0,n.jsxs)(v.A,{variant:"outline-secondary",className:"text-nowrap",children:[(0,n.jsx)(o.A,{size:16,className:"me-1"})," 文字"]}),(0,n.jsx)(m.A.Toggle,{split:!0,variant:"outline-secondary",id:"text-dropdown"}),(0,n.jsx)(m.A.Menu,{className:"p-3",style:{width:"250px"},children:(0,n.jsxs)(j.A.Group,{children:[(0,n.jsx)(j.A.Label,{className:"small mb-2",children:"輸入文字"}),(0,n.jsx)(j.A.Control,{as:"textarea",rows:3,value:q,onChange:e=>X(e.target.value),placeholder:"輸入要顯示的文字...",className:"mb-2"}),(0,n.jsx)("div",{className:"d-grid",children:(0,n.jsx)(v.A,{variant:"primary",size:"sm",onClick:()=>{if(!q.trim()||!e.current)return;let t=new a.DA(q,{left:100,top:100,fontFamily:"Arial",fontSize:30,fill:"#000000",selectable:!0,hasControls:!0,lockUniScaling:!1,lockRotation:!1,borderColor:"#3f51b5",cornerColor:"#3f51b5",cornerSize:12,transparentCorners:!1}),r="text-".concat(Date.now());t.set("data",{id:r}),e.current.add(t),N(e=>[...e,{id:r,type:"text",object:t,textContent:q,canChangeColor:!0,color:"#000000"}]),X(""),document.body.click()},disabled:!q.trim(),children:"確認"})})]})})]})]}),(0,n.jsx)("div",{className:"flex-shrink-0",children:(0,n.jsxs)("button",{onClick:el,disabled:!E,className:"btn btn-outline-danger text-nowrap",children:[(0,n.jsx)(d.A,{size:16,className:"me-1"}),"清除"]})})]}),(0,n.jsx)("div",{className:"d-flex justify-content-center",children:(0,n.jsx)("div",{ref:t,className:"border rounded overflow-hidden d-inline-flex justify-content-center align-items-center",children:(0,n.jsx)("canvas",{id:"video-canvas"})})})]})})}),(0,n.jsx)("input",{type:"file",ref:r,onChange:en,accept:"image/*,video/*",className:"d-none"}),(0,n.jsx)("div",{className:"col-md-12 text-start",children:b(C)})]}),(0,n.jsxs)(p.A,{show:S,onHide:()=>z(!1),children:[(0,n.jsx)(p.A.Header,{closeButton:!0,children:(0,n.jsx)(p.A.Title,{children:C.some(e=>"video"===e.type)?"下載影片":"下載圖片"})}),(0,n.jsx)(p.A.Body,{children:C.some(e=>"video"===e.type)?(0,n.jsxs)(j.A,{children:[(0,n.jsxs)(j.A.Group,{className:"mb-3",children:[(0,n.jsx)(j.A.Label,{children:"影片格式"}),(0,n.jsx)(j.A.Select,{value:F,onChange:e=>O(e.target.value),children:(0,n.jsx)("option",{value:"webm",children:"WebM"})})]}),(0,n.jsxs)(j.A.Group,{className:"mb-3",children:[(0,n.jsx)(j.A.Label,{children:"錄製幀率 (FPS)"}),(0,n.jsxs)(j.A.Select,{value:U,onChange:e=>H(e.target.value),children:[(0,n.jsx)("option",{value:"24",children:"24 FPS"}),(0,n.jsx)("option",{value:"30",children:"30 FPS"}),(0,n.jsx)("option",{value:"60",children:"60 FPS"})]})]}),(0,n.jsxs)(j.A.Group,{className:"mb-3",children:[(0,n.jsx)(j.A.Label,{children:"錄製時長 (秒)"}),(0,n.jsx)(j.A.Range,{min:"1",max:"30",value:I,onChange:e=>W(e.target.value)}),(0,n.jsxs)("div",{className:"text-center mt-2",children:[I," 秒"]})]}),(0,n.jsxs)(j.A.Group,{className:"mb-3",children:[(0,n.jsx)(j.A.Label,{children:"檔案名稱"}),(0,n.jsx)(j.A.Control,{type:"text",value:G,onChange:e=>P(e.target.value)})]})]}):(0,n.jsxs)(j.A,{children:[(0,n.jsxs)(j.A.Group,{className:"mb-3",children:[(0,n.jsx)(j.A.Label,{children:"圖片格式"}),(0,n.jsxs)(j.A.Select,{value:_,onChange:e=>D(e.target.value),children:[(0,n.jsx)("option",{value:"png",children:"PNG"}),(0,n.jsx)("option",{value:"jpeg",children:"JPEG"})]})]}),(0,n.jsxs)(j.A.Group,{className:"mb-3",children:[(0,n.jsx)(j.A.Label,{children:"檔案名稱"}),(0,n.jsx)(j.A.Control,{type:"text",value:M,onChange:e=>T(e.target.value)})]})]})}),(0,n.jsxs)(p.A.Footer,{children:[(0,n.jsx)(v.A,{variant:"secondary",onClick:()=>z(!1),children:"取消"}),(0,n.jsx)(v.A,{variant:"primary",onClick:()=>{R(!0),ee.current=f.Ay.loading("處理中..."),ei(),z(!1)},disabled:L,children:"確認下載"})]})]}),(0,n.jsxs)(p.A,{show:K,onHide:()=>Q(!1),children:[(0,n.jsx)(p.A.Header,{closeButton:!0,children:(0,n.jsx)(p.A.Title,{children:"調整顏色"})}),(0,n.jsx)(p.A.Body,{children:(0,n.jsx)(g.A,{value:(null==Y?void 0:Y.color)||"#000000",onChange:t=>{Y&&e.current&&(Y.object.set("fill",t),e.current.renderAll(),N(e=>e.map(e=>e.id===Y.id?{...e,color:t}:e)),J(e=>e?{...e,color:t}:null))}})})]}),(0,n.jsx)("button",{style:{position:"fixed",bottom:"32px",right:"32px",zIndex:999,borderRadius:"50%",width:"60px",height:"60px",fontSize:"24px",background:"#0d6efd",color:"#fff",border:"none",boxShadow:"0 2px 8px rgba(0,0,0,.2)",display:"flex",alignItems:"center",justifyContent:"center",padding:0,cursor:"pointer"},onClick:()=>$(!0),title:"物件列表",children:(0,n.jsx)(u.A,{})}),(0,n.jsxs)(p.A,{show:Z,onHide:()=>$(!1),size:"lg",children:[(0,n.jsx)(p.A.Header,{closeButton:!0,children:(0,n.jsx)(p.A.Title,{children:"物件列表"})}),(0,n.jsx)(p.A.Body,{children:(0,n.jsx)("div",{className:"d-flex flex-wrap gap-3",children:C.map(e=>{let t,r,l=e.color||"#000000";switch(e.type){case"image":t=(0,n.jsx)(s.A,{size:24,className:"mb-2"}),r="圖片";break;case"video":t=(0,n.jsx)(d.A,{size:24,className:"mb-2"}),r="影片";break;case"text":t=(0,n.jsx)(o.A,{size:24,className:"mb-2"}),r=e.textContent||"文字";break;default:t=null,r="未知"}return(0,n.jsxs)("div",{className:"position-relative",style:{width:"100px",cursor:"pointer"},onClick:()=>eo(e),children:[(0,n.jsx)("div",{className:"card h-100",style:{borderColor:e.color||"transparent",borderWidth:"2px",transition:"all 0.2s"},children:(0,n.jsxs)("div",{className:"card-body p-2 text-center",style:{color:l},children:[t,(0,n.jsx)("div",{className:"small text-truncate",style:{color:l,fontWeight:"bold"},children:r})]})}),(0,n.jsx)("button",{className:"position-absolute top-0 end-0 btn btn-sm btn-outline-danger p-0",style:{width:"24px",height:"24px",zIndex:10},onClick:t=>{t.stopPropagation(),ea(e.id)},children:(0,n.jsx)(h.A,{size:12})})]},e.id)})})})]})]})}},90981:(e,t,r)=>{Promise.resolve().then(r.bind(r,27152))}},e=>{var t=t=>e(e.s=t);e.O(0,[4776,3518,1500,669,808,7232,8441,1684,7358],()=>t(90981)),_N_E=e.O()}]);