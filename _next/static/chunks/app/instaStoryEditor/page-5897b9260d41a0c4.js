(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[694],{9134:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var r=n(95155);n(12115);var l=n(70808);let i=e=>{let{value:t,onChange:n}=e;return(0,r.jsxs)("div",{className:"d-flex flex-column align-items-center",children:[(0,r.jsx)("h5",{children:"顏色選擇"}),(0,r.jsx)(l.xk,{color:t,onChange:e=>{n(e.hex)}})]})}},90981:(e,t,n)=>{Promise.resolve().then(n.bind(n,94200))},94200:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>A});var r=n(95155),l=n(12115),i=n(43745),s=n(5790),a=n(30967),c=n(16850),o=n(94139),d=n(31523),u=n(81796),m=n(95789),h=n(77126),x=n(66449),v=n(60902),p=n(8827),j=n(45831),b=n(13568),f=n(9134);let g=()=>{let e=window.innerWidth>=1080;if(console.log(window.innerWidth),e)return{width:.8*window.innerWidth,height:.8*window.innerHeight};let t=Math.min(.9*window.innerWidth,1080)/1080;return{width:Math.floor(1080*t),height:Math.floor(1920*t)}};function A(){let e=(0,l.useRef)(null),t=(0,l.useRef)(null),n=(0,l.useRef)(null),A=(0,l.useRef)(new Map),w=(0,l.useRef)(null),[y,C]=(0,l.useState)([]),[E,N]=(0,l.useState)(null),[k,S]=(0,l.useState)(!1),[L,z]=(0,l.useState)(!1),[R,I]=(0,l.useState)("10"),[W,F]=(0,l.useState)("webm"),[H,M]=(0,l.useState)("30"),[O,U]=(0,l.useState)("canvas-video"),[D,G]=(0,l.useState)("png"),[P,_]=(0,l.useState)("canvas-image"),[T,B]=(0,l.useState)(g()),[X,Y]=(0,l.useState)(""),[V,q]=(0,l.useState)(null),[J,K]=(0,l.useState)(!1),[Q,Z]=(0,l.useState)(!1),$=(0,l.useRef)(void 0),[ee,et]=(0,l.useState)({x:-1e3,y:-1e3}),en=(0,l.useRef)(!1),er=(0,l.useRef)({x:0,y:0});(0,l.useEffect)(()=>{et({x:window.innerWidth-32-60,y:125})},[]);let el=e=>{en.current=!1;let t="touches"in e?e.touches[0].clientX:e.clientX,n="touches"in e?e.touches[0].clientY:e.clientY;er.current={x:t-ee.x,y:n-ee.y};let r=e=>{en.current=!0,e.cancelable&&e.preventDefault();let t="touches"in e?e.touches[0].clientX:e.clientX,n="touches"in e?e.touches[0].clientY:e.clientY,r=t-er.current.x,l=n-er.current.y,i=window.innerWidth-60,s=window.innerHeight-60;et({x:r=Math.max(0,Math.min(r,i)),y:l=Math.max(0,Math.min(l,s))})},l=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",l),document.removeEventListener("touchmove",r),document.removeEventListener("touchend",l)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",l),document.addEventListener("touchmove",r,{passive:!1}),document.addEventListener("touchend",l)};(0,l.useEffect)(()=>{if(!t.current)return;let n=new i.Hl("video-canvas",{width:T.width,height:T.height,backgroundColor:"#f0f0f0",preserveObjectStacking:!0});return e.current=n,()=>{A.current.forEach(e=>{cancelAnimationFrame(e)}),A.current.clear(),n.dispose()}},[T]),(0,l.useEffect)(()=>{let n=()=>{t.current&&e.current&&(e.current.setWidth(t.current.clientWidth),e.current.renderAll())};return window.addEventListener("resize",n),()=>window.removeEventListener("resize",n)},[]);let ei=e=>new Promise((t,n)=>{let r=new Image;r.crossOrigin="anonymous",r.onload=()=>{try{let e=new i._V(r,{left:100,top:100,scaleX:.5,scaleY:.5,selectable:!0,hasControls:!0,lockUniScaling:!1,lockRotation:!1,borderColor:"#3f51b5",cornerColor:"#3f51b5",cornerSize:12,transparentCorners:!1}),n="obj-".concat(Date.now());e.set("data",{id:n}),t(e)}catch(e){n(e)}},r.onerror=()=>n(Error("圖片加載失敗")),r.src=e}),es=e=>new Promise((t,n)=>{let r=document.createElement("canvas"),l=r.getContext("2d");if(!l)return void n(Error("無法獲取臨時畫布上下文"));r.width=e.videoWidth,r.height=e.videoHeight,l.drawImage(e,0,0,r.width,r.height);let s=new Image;s.crossOrigin="anonymous",s.onload=()=>{try{let e=new i._V(s,{left:100,top:100,scaleX:.5,scaleY:.5,selectable:!0,hasControls:!0,lockUniScaling:!1,lockRotation:!1,borderColor:"#3f51b5",cornerColor:"#3f51b5",cornerSize:12,transparentCorners:!1}),n="vid-".concat(Date.now());e.set("data",{id:n}),t(e)}catch(e){n(e)}},s.onerror=()=>n(Error("影片幀圖片加載失敗")),s.src=r.toDataURL("image/png")}),ea=async e=>{var t;let n=null==(t=e.target.files)?void 0:t[0];if(!n)return;let r=URL.createObjectURL(n);N(r);try{if(n.type.startsWith("image/")){let e=await ei(r);C(t=>[...t,{id:e.get("data").id,type:"image",object:e,canChangeColor:!1}])}else if(n.type.startsWith("video/")){let e=document.createElement("video");e.style.display="none",e.src=r,e.muted=!0,e.loop=!0,e.crossOrigin="anonymous",e.playsInline=!0,document.body.appendChild(e),e.addEventListener("error",e=>{console.error("影片加載錯誤:",e)}),await new Promise(t=>{e.addEventListener("canplay",()=>{t()}),e.load()});let t=await es(e);C(n=>[...n,{id:t.get("data").id,type:"video",object:t,videoElement:e,canChangeColor:!1}]),e.play().catch(e=>{console.error("自動播放失敗:",e)})}}catch(e){console.error("處理檔案時發生錯誤:",e)}};(0,l.useEffect)(()=>{if(e.current)return e.current.clear(),e.current.backgroundColor="#f0f0f0",e.current.renderAll(),A.current.forEach(e=>{cancelAnimationFrame(e)}),A.current.clear(),y.forEach(t=>{var n;if(null==(n=e.current)||n.add(t.object),"video"===t.type&&t.videoElement){let n=()=>{if(!e.current||!t.videoElement||!t.object)return;let r=document.createElement("canvas"),l=r.getContext("2d");if(!l)return;r.width=t.videoElement.videoWidth,r.height=t.videoElement.videoHeight,l.drawImage(t.videoElement,0,0,r.width,r.height);let s=new Image;s.onload=()=>{var r,l;if(t.object&&t.object instanceof i._V&&(t.object.setElement(s),null==(r=e.current)||r.renderAll(),!(null==(l=t.videoElement)?void 0:l.paused))){let e=requestAnimationFrame(n);A.current.set(t.id,e)}},s.src=r.toDataURL("image/png")};n()}}),y.length>0&&e.current.setActiveObject(y[y.length-1].object),e.current.renderAll(),()=>{A.current.forEach(e=>{cancelAnimationFrame(e)}),A.current.clear()}},[y]);let ec=(0,l.useCallback)(()=>{e.current&&(A.current.forEach(e=>{cancelAnimationFrame(e)}),A.current.clear(),e.current.clear(),e.current.backgroundColor="#f0f0f0",e.current.renderAll(),y.forEach(e=>{if(e.videoElement){var t;e.videoElement.pause();let n=e.videoElement.cloneNode(!1);null==(t=e.videoElement.parentNode)||t.replaceChild(n,e.videoElement),n.src="",n.remove()}e.object instanceof i._V&&e.object.dispose()}),N(null),C([]))},[y]),eo=t=>{if(!e.current)return;let n=y.find(e=>e.id===t);if(n){let l=A.current.get(n.id);if(l&&(cancelAnimationFrame(l),A.current.delete(n.id)),e.current.remove(n.object),n.videoElement){var r;n.videoElement.pause();let e=n.videoElement.cloneNode(!1);null==(r=n.videoElement.parentNode)||r.replaceChild(e,n.videoElement),e.src="",e.remove()}n.object instanceof i._V&&n.object.dispose(),C(e=>e.filter(e=>e.id!==t)),e.current.renderAll()}},ed=t=>{if(!e.current)return;let n=y.find(e=>e.id===t);n&&(e.current.setActiveObject(n.object),e.current.renderAll())},eu=()=>{if(!e.current||0===y.length){b.Ay.error("畫布為空，無法下載！"),z(!1),$.current=void 0;return}if(y.some(e=>"video"===e.type)){let t=parseFloat(R);if(isNaN(t)||t<1||t>30){b.Ay.error("請輸入 1-30 秒的有效時長"),b.Ay.dismiss($.current),$.current=void 0,z(!1);return}if(!O||/[\\/:*?"<>|]/.test(O)){b.Ay.error("檔案名稱無效，請避免特殊字元"),b.Ay.dismiss($.current),z(!1),$.current=void 0;return}y.forEach(e=>{e.videoElement&&(e.videoElement.currentTime=0,e.videoElement.play().catch(e=>{console.error("重新播放失敗:",e)}))});let n=e.current.getElement().captureStream(parseInt(H)),r=[];w.current=new MediaRecorder(n,{mimeType:"video/webm"}),w.current.ondataavailable=e=>{e.data.size>0&&r.push(e.data)},w.current.onstop=()=>{let e=new Blob(r,{type:"video/webm"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="".concat(O,".webm"),n.click(),URL.revokeObjectURL(t),y.forEach(e=>{e.videoElement&&e.videoElement.paused&&e.videoElement.play().catch(e=>{console.error("恢復播放失敗:",e)})}),b.Ay.dismiss($.current),b.Ay.success("下載成功！"),$.current=void 0,z(!1)},w.current.start(),setTimeout(()=>{w.current&&"inactive"!==w.current.state&&w.current.stop()},1e3*t)}else{let t;if(!P||/[\\/:*?"<>|]/.test(P)){b.Ay.error("檔案名稱無效，請避免特殊字元"),b.Ay.dismiss($.current),$.current=void 0,z(!1);return}if(t="jpeg"===D?e.current.toDataURL({format:"jpeg",quality:.8,multiplier:1}):e.current.toDataURL({format:"png",multiplier:1})){let e=document.createElement("a");e.href=t,e.download="".concat(P,".").concat(D),e.click(),b.Ay.dismiss($.current),b.Ay.success("下載成功！"),$.current=void 0,z(!1)}z(!1)}},em=(n,r)=>{if(e.current&&t.current){let l=n||t.current.clientWidth;e.current.setDimensions({width:l,height:r}),B({width:l,height:r}),e.current.renderAll()}},eh=t=>{e.current&&(e.current.setActiveObject(t.object),e.current.renderAll(),t.canChangeColor&&(q(t),ed(t.id),K(!0)))};return(0,r.jsxs)("div",{className:"container-fluid",children:[(0,r.jsxs)("div",{className:"row justify-content-center",style:{paddingTop:"70px"},children:[(0,r.jsx)("div",{className:"col-12 col-lg-10",children:(0,r.jsx)("div",{className:"card mb-4",children:(0,r.jsxs)("div",{className:"card-body",children:[(0,r.jsxs)("div",{className:"d-flex justify-content-between align-items-start mb-3 w-100",children:[(0,r.jsxs)("div",{className:"d-flex flex-wrap gap-2 me-2",style:{maxWidth:"calc(100% - 100px)"},children:[(0,r.jsxs)("button",{onClick:()=>{var e;return null==(e=n.current)?void 0:e.click()},className:"btn btn-outline-primary text-nowrap",children:[(0,r.jsx)(s.A,{size:16,className:"me-1"}),"上傳"]}),(0,r.jsxs)("button",{className:"btn btn-outline-success text-nowrap",disabled:0===y.length||L,onClick:()=>{e.current&&(e.current.discardActiveObject(),e.current.renderAll()),S(!0)},children:[(0,r.jsx)(a.A,{size:16,className:"me-1"}),"下載"]}),(0,r.jsxs)(h.A,{as:x.A,className:"text-nowrap",children:[(0,r.jsxs)(v.A,{variant:"outline-secondary",className:"text-nowrap",children:[(0,r.jsx)(c.A,{size:16,className:"me-1"}),"尺寸"]}),(0,r.jsx)(h.A.Toggle,{split:!0,variant:"outline-secondary",id:"canvas-size-dropdown"}),(0,r.jsxs)(h.A.Menu,{children:[(0,r.jsx)(h.A.Header,{children:"常用尺寸"}),(0,r.jsx)(h.A.Item,{onClick:()=>em(1080,1920),children:"Instagram 動態 (1080x1920)"}),(0,r.jsx)(h.A.Item,{onClick:()=>em(1080,1350),children:"Instagram 貼文 (1080x1350)"}),(0,r.jsx)(h.A.Item,{onClick:()=>em(1080,1080),children:"Instagram 方形 (1080x1080)"}),(0,r.jsx)(h.A.Item,{onClick:()=>em(g().width,g().height),children:"初始化尺寸"}),(0,r.jsx)(h.A.Divider,{}),(0,r.jsx)(h.A.Header,{children:"自訂"}),(0,r.jsxs)("div",{className:"px-3 py-2",children:[(0,r.jsxs)(p.A.Group,{className:"mb-2",children:[(0,r.jsx)(p.A.Label,{className:"small mb-1",children:"寬度 (px)"}),(0,r.jsx)(p.A.Control,{type:"number",size:"sm",value:T.width,onChange:e=>em(Number(e.target.value),T.height)})]}),(0,r.jsxs)(p.A.Group,{children:[(0,r.jsx)(p.A.Label,{className:"small mb-1",children:"高度 (px)"}),(0,r.jsx)(p.A.Control,{type:"number",size:"sm",value:T.height,onChange:e=>em(T.width,Number(e.target.value))})]})]})]})]}),(0,r.jsxs)(h.A,{as:x.A,className:"text-nowrap",children:[(0,r.jsxs)(v.A,{variant:"outline-secondary",className:"text-nowrap",children:[(0,r.jsx)(o.A,{size:16,className:"me-1"})," 文字"]}),(0,r.jsx)(h.A.Toggle,{split:!0,variant:"outline-secondary",id:"text-dropdown"}),(0,r.jsx)(h.A.Menu,{className:"p-3",style:{width:"250px"},children:(0,r.jsxs)(p.A.Group,{children:[(0,r.jsx)(p.A.Label,{className:"small mb-2",children:"輸入文字"}),(0,r.jsx)(p.A.Control,{as:"textarea",rows:3,value:X,onChange:e=>Y(e.target.value),placeholder:"輸入要顯示的文字...",className:"mb-2"}),(0,r.jsx)("div",{className:"d-grid",children:(0,r.jsx)(v.A,{variant:"primary",size:"sm",onClick:()=>{if(!X.trim()||!e.current)return;let t=new i.DA(X,{left:100,top:100,fontFamily:"Arial",fontSize:30,fill:"#000000",selectable:!0,hasControls:!0,lockUniScaling:!1,lockRotation:!1,borderColor:"#3f51b5",cornerColor:"#3f51b5",cornerSize:12,transparentCorners:!1}),n="text-".concat(Date.now());t.set("data",{id:n}),e.current.add(t),C(e=>[...e,{id:n,type:"text",object:t,textContent:X,canChangeColor:!0,color:"#000000"}]),Y(""),document.body.click()},disabled:!X.trim(),children:"確認"})})]})})]})]}),(0,r.jsx)("div",{className:"flex-shrink-0",children:(0,r.jsxs)("button",{onClick:ec,disabled:!E,className:"btn btn-outline-danger text-nowrap",children:[(0,r.jsx)(d.A,{size:16,className:"me-1"}),"清除"]})})]}),(0,r.jsx)("div",{className:"d-flex justify-content-center",children:(0,r.jsx)("div",{ref:t,className:"border rounded overflow-hidden d-inline-flex justify-content-center align-items-center",children:(0,r.jsx)("canvas",{id:"video-canvas"})})})]})})}),(0,r.jsx)("input",{type:"file",ref:n,onChange:ea,accept:"image/*,video/*",className:"d-none"})]}),(0,r.jsxs)(j.A,{show:k,onHide:()=>S(!1),children:[(0,r.jsx)(j.A.Header,{closeButton:!0,children:(0,r.jsx)(j.A.Title,{children:y.some(e=>"video"===e.type)?"下載影片":"下載圖片"})}),(0,r.jsx)(j.A.Body,{children:y.some(e=>"video"===e.type)?(0,r.jsxs)(p.A,{children:[(0,r.jsxs)(p.A.Group,{className:"mb-3",children:[(0,r.jsx)(p.A.Label,{children:"影片格式"}),(0,r.jsx)(p.A.Select,{value:W,onChange:e=>F(e.target.value),children:(0,r.jsx)("option",{value:"webm",children:"WebM"})})]}),(0,r.jsxs)(p.A.Group,{className:"mb-3",children:[(0,r.jsx)(p.A.Label,{children:"錄製幀率 (FPS)"}),(0,r.jsxs)(p.A.Select,{value:H,onChange:e=>M(e.target.value),children:[(0,r.jsx)("option",{value:"24",children:"24 FPS"}),(0,r.jsx)("option",{value:"30",children:"30 FPS"}),(0,r.jsx)("option",{value:"60",children:"60 FPS"})]})]}),(0,r.jsxs)(p.A.Group,{className:"mb-3",children:[(0,r.jsx)(p.A.Label,{children:"錄製時長 (秒)"}),(0,r.jsx)(p.A.Range,{min:"1",max:"30",value:R,onChange:e=>I(e.target.value)}),(0,r.jsxs)("div",{className:"text-center mt-2",children:[R," 秒"]})]}),(0,r.jsxs)(p.A.Group,{className:"mb-3",children:[(0,r.jsx)(p.A.Label,{children:"檔案名稱"}),(0,r.jsx)(p.A.Control,{type:"text",value:O,onChange:e=>U(e.target.value)})]})]}):(0,r.jsxs)(p.A,{children:[(0,r.jsxs)(p.A.Group,{className:"mb-3",children:[(0,r.jsx)(p.A.Label,{children:"圖片格式"}),(0,r.jsxs)(p.A.Select,{value:D,onChange:e=>G(e.target.value),children:[(0,r.jsx)("option",{value:"png",children:"PNG"}),(0,r.jsx)("option",{value:"jpeg",children:"JPEG"})]})]}),(0,r.jsxs)(p.A.Group,{className:"mb-3",children:[(0,r.jsx)(p.A.Label,{children:"檔案名稱"}),(0,r.jsx)(p.A.Control,{type:"text",value:P,onChange:e=>_(e.target.value)})]})]})}),(0,r.jsxs)(j.A.Footer,{children:[(0,r.jsx)(v.A,{variant:"secondary",onClick:()=>S(!1),children:"取消"}),(0,r.jsx)(v.A,{variant:"primary",onClick:()=>{z(!0),$.current=b.Ay.loading("處理中..."),eu(),S(!1)},disabled:L,children:"確認下載"})]})]}),(0,r.jsxs)(j.A,{show:J,onHide:()=>K(!1),children:[(0,r.jsx)(j.A.Header,{closeButton:!0,children:(0,r.jsx)(j.A.Title,{children:"調整顏色"})}),(0,r.jsx)(j.A.Body,{children:(0,r.jsx)(f.A,{value:(null==V?void 0:V.color)||"#000000",onChange:t=>{V&&e.current&&(V.object.set("fill",t),e.current.renderAll(),C(e=>e.map(e=>e.id===V.id?{...e,color:t}:e)),q(e=>e?{...e,color:t}:null))}})})]}),(0,r.jsx)("button",{style:{position:"fixed",left:"".concat(ee.x,"px"),top:"".concat(ee.y,"px"),zIndex:999,borderRadius:"50%",width:"60px",height:"60px",fontSize:"24px",background:"#0d6efd",color:"#fff",border:"none",boxShadow:"0 2px 8px rgba(0,0,0,.2)",display:-1e3===ee.x?"none":"flex",alignItems:"center",justifyContent:"center",padding:0,cursor:"grab",touchAction:"none"},onMouseDown:el,onTouchStart:el,onClick:()=>{en.current||Z(!0)},title:"物件列表",children:(0,r.jsx)(u.A,{})}),(0,r.jsxs)(j.A,{show:Q,onHide:()=>Z(!1),size:"lg",children:[(0,r.jsx)(j.A.Header,{closeButton:!0,children:(0,r.jsx)(j.A.Title,{children:"物件列表"})}),(0,r.jsx)(j.A.Body,{children:(0,r.jsx)("div",{className:"d-flex flex-wrap gap-3",children:y.map(e=>{let t,n,l=e.color||"#000000";switch(e.type){case"image":t=(0,r.jsx)(s.A,{size:24,className:"mb-2"}),n="圖片";break;case"video":t=(0,r.jsx)(d.A,{size:24,className:"mb-2"}),n="影片";break;case"text":t=(0,r.jsx)(o.A,{size:24,className:"mb-2"}),n=e.textContent||"文字";break;default:t=null,n="未知"}return(0,r.jsxs)("div",{className:"position-relative",style:{width:"100px",cursor:"pointer"},onClick:()=>eh(e),children:[(0,r.jsx)("div",{className:"card h-100",style:{borderColor:e.color||"transparent",borderWidth:"2px",transition:"all 0.2s"},children:(0,r.jsxs)("div",{className:"card-body p-2 text-center",style:{color:l},children:[t,(0,r.jsx)("div",{className:"small text-truncate",style:{color:l,fontWeight:"bold"},children:n})]})}),(0,r.jsx)("button",{className:"position-absolute top-0 end-0 btn btn-sm btn-outline-danger p-0",style:{width:"24px",height:"24px",zIndex:10},onClick:t=>{t.stopPropagation(),eo(e.id)},children:(0,r.jsx)(m.A,{size:12})})]},e.id)})})})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[4776,3518,4488,669,808,7232,8441,1684,7358],()=>t(90981)),_N_E=e.O()}]);